<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Geokätkötilastot</title>
    <style>
        body {
            margin: 0;
            /* padding-top will be set by JavaScript */
            font-family: sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }

        /* Style for the user input area - now fixed at the top */
        #userControlArea {
            position: fixed; /* Keep it fixed at the top */
            top: 0; /* Align to the very top */
            left: 0;
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
            padding: 10px; /* Padding inside the area */
            background-color: #1f1f1f; /* Background to match nav */
            border-bottom: 1px solid #333; /* Separator line */
            z-index: 1000; /* Make sure it's above the nav and other content */
            display: flex; /* Use flexbox for layout */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: center; /* Vertically align items */
            gap: 10px; /* Space between items */
            /* KORJAUS: POISTETTU position: relative; - Tämä aiheutti ristiriidan fixed-positionin kanssa */
        }

        /* New style for the logo within the userControlArea */
        #userControlArea .logo {
            height: 40px; /* Example size - Adjust as needed for mikkokalevi.png */
            width: 40px;  /* Example size - Adjust as needed */
            margin-right: 10px; /* Space between logo and subsequent items */
            flex-shrink: 0; /* Prevent shrinking */
            object-fit: contain; /* Maintain aspect ratio without stretching */
            vertical-align: middle; /* Align logo nicely */
        }

         #userControlArea > div:first-of-type { /* Geokätkötilastot käyttäjälle div */
             margin: 0; /* Remove default div margin */
             flex-shrink: 1; /* Allow this div to take space but shrink if needed */
             white-space: nowrap; /* Prevent wrapping for the text */
             min-width: 150px; /* Ensure it takes some space */
         }

        /* Container for input, button, and suggestions */
        #inputContainer {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-grow: 1; /* Allow to take available space */
            flex-wrap: wrap; /* Allow input and button to wrap */
            position: relative; /* Tarvitaan ehdotusten absoluuttiseen positiointiin */
        }


        /* Styles for the input and button */
        #usernameInput {
             padding: 8px;
             border-radius: 5px;
             border: 1px solid #555;
             background-color: #333;
             color: #fff;
             font-size: 14px;
             flex-grow: 1; /* Allow input to grow */
             min-width: 120px; /* Minimum width for input */
         }

        #updateButton {
            padding: 8px 15px; /* Add padding for button */
            border-radius: 5px;
            border: 1px solid #0077cc; /* Blue border */
            background-color: #0077cc; /* Blue background */
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }

         #updateButton:hover {
             background-color: #005fa3;
             border-color: #005fa3;
         }

        nav {
            position: fixed; /* Keep it fixed */
            /* top will be set by JavaScript */
            left: 0;
            width: 100%;
            background-color: #1f1f1f;
            border-bottom: 1px solid #333;
            padding: 10px;
            box-sizing: border-box; /* Include padding in width */
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap */
            align-items: center;
            z-index: 999; /* Below userControlArea but above content */
        }

        .nav-title {
            margin-right: 20px;
            font-weight: bold;
            font-size: 14px;
            color: #f0f0f0;
            white-space: nowrap;
        }

        .nav-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 0;
        }

         @media (max-width: 767px) {
             .nav-group {
                 margin-top: 10px; /* Add space if wrapping occurs */
                 width: 100%; /* Take full width */
             }
         }

        .nav-heading {
            font-weight: bold;
            font-size: 15px;
            color: #cccccc;
            margin: 0 10px;
            display: flex;
            align-items: center;
        }

        nav a {
            text-decoration: none;
            background-color: #333;
            color: #ffffff;
            font-weight: bold;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        nav a:hover {
            background-color: #555;
        }

        nav a.active {
            background-color: #0077cc;
            color: white;
        }

        /* Piilota sisältöalue oletuksena */
        #statsContent {
            display: none; /* Initially hidden */
            position: relative; /* Needed for positioning spinner absolutely */
            min-height: 200px; /* Prevent content collapse when hidden/loading - Adjust as needed */
            padding: 0 10px; /* Lisää sisäpuolista paddingia */
        }

        h2 {
            /* margin-top will be taken care of by body padding-top */
            margin: 40px 0 5px; /* Reduced bottom margin to place link closer */
            font-size: 22px;
             /* scroll-margin-top will be set by JavaScript */
             padding-left: 10px; /* Siirrä otsikkoa hieman sisään */
        }

        h3 {
            margin: 20px 0 10px; /* Adjust margin */
            font-size: 18px;
            color: #cccccc;
             padding-left: 10px; /* Siirrä otsikkoa hieman sisään */
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 20px 0; /* Center images? Or keep left? Kept left alignment from original. Removed left margin, added padding to container */
            border-radius: 5px;
             box-sizing: border-box; /* Include border in width */
        }

        h3 + img {
             margin-top: 10px;
        }

        .content-link {
            display: inline-block;
            margin: 10px 0; /* Adjust margin */
            padding: 8px 14px;
            background-color: #0077cc;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .content-link:hover {
            background-color: #005fa3;
        }

        /* Style for the back-to-top link button placed after H2 */
        .back-to-top {
            /* Inherits content-link styles */
            display: inline-block; /* Keep it inline-block to flow after H2 */
            margin: 0 10px 20px 10px; /* Adjust margin: top right bottom left */
            font-size: 12px; /* Slightly smaller font */
            vertical-align: middle; /* Align vertically with the heading */
        }


        .version {
            margin: 30px 10px 10px;
            font-size: 12px;
            color: #888;
            text-align: right;
        }

        /* Spinner styles */
        #loadingSpinner {
            display: none; /* Initially hidden by JS */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #0077cc; /* Spinner color */
            border-radius: 50%;
            animation: spin 1s linear infinite; /* Animation */
            z-index: 10; /* Above potential content */
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Styles for the suggestions dropdown */
        .suggestions-dropdown {
            position: absolute; /* Position relative to the containing block (#inputContainer) */
            top: 100%; /* Position below the inputContainer */
            left: 0;
            right: 0; /* Extend to the right edge of inputContainer */
            z-index: 1002; /* Above userControlArea */
            background-color: #2b2b2b; /* Dark background */
            border: 1px solid #555;
            border-top: none; /* No top border as it connects to input */
            border-radius: 0 0 5px 5px; /* Rounded bottom corners */
            max-height: 150px; /* Limit height and enable scrolling */
            overflow-y: auto;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            display: none; /* Hidden by default */
            padding: 0; /* No internal padding */
            margin-top: 0; /* No margin top */
        }

        .suggestions-dropdown span {
            display: block; /* Each suggestion on a new line */
            padding: 8px 15px; /* Padding inside suggestion item */
            cursor: pointer;
            color: #e0e0e0;
        }

        .suggestions-dropdown span:hover {
            background-color: #3c3c3c; /* Hover effect */
            color: #ffffff;
        }


    </style>
</head>
<body id="top">
    <div id="userControlArea">
        <img src="mikkokalevi.png" alt="Käyttäjän logo" class="logo">
        <div>
            Geokätkötilastot käyttäjälle: <span id="currentUsername">[Ei käyttäjää]</span>
        </div>
        <div id="inputContainer">
            <input type="text" id="usernameInput" value="" placeholder="Syötä käyttäjätunnus">
            <button id="updateButton">Päivitä</button>
            <div id="usernameSuggestions" class="suggestions-dropdown">
                </div>
        </div>
    </div>
    <nav>
        <div class="nav-title">Navigointi:</div>
        <div class="nav-group">
            <div class="nav-heading">*</div>
            <a href="#dt2025">T/D 2025</a>
            <a href="#dt">T/D full</a>
            <a href="#dt_month">T/D KK</a>
            <a href="#dt_day">T/D KK/PV PGC</a>
            <a href="#vvtyyp">VV / tyyppi</a>

            <div class="nav-heading">*</div>
            <a href="#paiva">Päivä läydöt</a>

            <div class="nav-heading">*</div>
            <a href="#kaikki">Vuosikalenterit</a>
            <a href="#maakunta">Maakunnat</a>

            <div class="nav-heading">*</div>
            <a href="#kuntakartta">Kuntakartat</a>
            <a href="#tripletti">Tripletti</a>
            <a href="#graticule">Graticule</a>
            <a href="#ftf">FTF</a>
            <a href="#miitti">Miitti</a>
            <a href="#isokunta">Iso</a>

            <div class="nav-heading">*</div>
            <a href="#jasmer">Jasmer</a>
        </div>
    </nav>

    <div id="statsContent">
        <div id="loadingSpinner" class="spinner"></div>

        <h2 id="dt2025">T/D 2025</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&year=2025">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&year=2025&cachetype=1">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&year=2025&cachetype=2">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&year=2025&cachetype=3">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&year=2025&cachetype=6">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&year=2025&cachetype=7">


        <h2 id="dt">T/D full</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&cachetype=1">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&cachetype=2">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&cachetype=3">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&cachetype=6">
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&cachetype=7">


        <h2 id="dt_month">T/D Kuukaudet</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <h3>Tammikuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=01">
        <h3>Helmikuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=02">
        <h3>Maaliskuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=03">
        <h3>Huhtikuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=04">
        <h3>Toukokuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=05">
        <h3>Kesäkuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=06">
        <h3>Heinäkuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=07">
        <h3>Elokuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=08">
        <h3>Syyskuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=09">
        <h3>Lokakuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=10">
        <h3>Marraskuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=11">
        <h3>Joulukuu</h3>
        <img data-src="https://www.geocache.fi/stat/matrix.php?la=&user=mikkokalevi&month=12">


        <h2 id="dt_day">T/D kk/päivät PGC</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <a class="content-link" data-href="https://project-gc.com/Challenges//76983" target="_blank">Linkki chekkeriin</a>


        <h2 id="vvtyyp">Löydöt vuosi / tyyppi</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/yeartype.php?la=&user=mikkokalevi">


        <h2 id="paiva">Päivä läydöt</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/day.php?la=&user=mikkokalevi">


        <h2 id="kaikki">Vuosikalenterit</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&year=2025">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=1">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=2">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=3">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=4">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=99">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=7">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=9">
        <img data-src="http://www.geocache.fi/stat/year.php?&user=mikkokalevi&cachetype=20">


        <h2 id="maakunta">Maakunnat</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <h3>Päijät-häme</h3>
        <img data-src="https://www.geocache.fi/stat/year.php?&user=mikkokalevi&mkunta=P%C3%A4ij%C3%A4t-H%C3%A4me">
        <h3>Kymenlaakso</h3>
        <img data-src="https://www.geocache.fi/stat/year.php?&user=mikkokalevi&mkunta=kymenlaakso">
        <h3>Kanta-häme</h3>
        <img data-src="https://www.geocache.fi/stat/year.php?&user=mikkokalevi&mkunta=Kanta-H%C3%A4me">
        <h3>Varsinais-Suomi</h3>
        <img data-src="https://www.geocache.fi/stat/year.php?&user=mikkokalevi&mkunta=Varsinais-Suomi">
        <h3>Uusimaa</h3>
        <img data-src="https://www.geocache.fi/stat/year.php?&user=mikkokalevi&mkunta=Uusimaa">


        <h2 id="kuntakartta">Kuntakartat</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi">
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi&cachetype=1">
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi&cachetype=2">
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi&cachetype=3">
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi&cachetype=6">
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi&cachetype=7">


        <h2 id="tripletti">Tripletti kuntakartta</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&user=mikkokalevi&slide=0&cachetype=90">

        <h2 id="graticule">Graticule</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/grat.php?la=&user=mikkokalevi">

        <h2 id="ftf">FTF Kuntakartta</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/ftfkunta.php?la=&slide=1&user=mikkokalevi">


        <h2 id="miitti">Miitti Kuntakartta</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>
        <img data-src="https://www.geocache.fi/stat/kunta.php?la=&slide=1&user=mikkokalevi&cachetype=99">


        <h2 id="isokunta">Iso kuntakartta</h2><a href="#top" class="content-link back-to-top">Takaisin ylös</a>


        <h2 id="jasmer">Jasmer</h2>
        <img data-src="https://www.geocache.fi/stat/hiddenday.php?la=&type=2&user=mikkokalevi">
        <a class="content-link" data-href="https://www.geocache.fi/stat/hiddenday.php?la=&user=mikkokalevi&type=2&cachetype=1" target="_blank">Jasmer tradi</a>
        <a class="content-link" data-href="https://www.geocache.fi/stat/hiddenday.php?la=&user=mikkokalevi&type=2&cachetype=2" target="_blank">Jasmer multi</a>
        <a class="content-link" data-href="https://www.geocache.fi/stat/hiddenday.php?la=&user=mikkokalevi&type=2&cachetype=3" target="_blank">Jasmer mysse</a>

    </div> <div class="version">Versio 30 (muokattu)</div>

    <br><br><br><br><br>

    <script>
        const sections = document.querySelectorAll("h2[id]");
        const navLinks = document.querySelectorAll("nav a");
        const userControlArea = document.getElementById('userControlArea');
        const navBar = document.querySelector('nav');
        const usernameInput = document.getElementById('usernameInput');
        const updateButton = document.getElementById('updateButton');
        const currentUsernameSpan = document.getElementById('currentUsername');
        const h2Elements = document.querySelectorAll('h2');
        const statsContent = document.getElementById('statsContent');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const usernameSuggestionsDiv = document.getElementById('usernameSuggestions');

        const suggestedUsernames = ['mikkokalevi', 'eukka', 'Tiltu', 'lahjemies', 'milde04'];
        let currentImagesLoading = 0;


        // Function to adjust padding and margins based on fixed header heights
        // This is crucial for keeping userControlArea and nav fixed and content below them
        function adjustLayout() {
            const userAreaHeight = userControlArea.offsetHeight;
            const navHeight = navBar.offsetHeight;
            const totalFixedHeight = userAreaHeight + navHeight;

            // Set the top position of the nav bar right below the user control area
            navBar.style.top = userAreaHeight + 'px';

            // Set padding-top for the body to push content below both fixed headers
            document.body.style.paddingTop = totalFixedHeight + 'px';
            console.log('Adjusted layout. User Area Height:', userAreaHeight, 'Nav Height:', navHeight, 'Total Padding:', totalFixedHeight);


            // Set scroll-margin-top for H2 elements so anchor links scroll correctly below headers
            h2Elements.forEach(h2 => {
                h2.style.scrollMarginTop = totalFixedHeight + 'px';
            });

             // Adjust the rootMargin for the Intersection Observer
             // This makes the active link highlighting more accurate below fixed headers
             observer.rootMargin = `-${totalFixedHeight + 10}px 0px -60% 0px`; // Added a small buffer
        }


        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    // Only update active nav links if statsContent is currently visible
                    if (statsContent.style.display !== 'none') {
                        navLinks.forEach(link => {
                            link.classList.toggle("active", link.getAttribute("href") === "#" + id);
                        });
                    }
                }
            });
        }, {
             threshold: 0.1 // Trigger when 10% of the section is visible
        });

        // Observe H2 elements for scroll spy, even if content is initially hidden
        sections.forEach(section => {
            observer.observe(section);
        });

        // --- JavaScript for username update and loading ---

        function updateStats(username) {
            const cleanUsername = username.trim();
             console.log('updateStats called with:', username, '(trimmed:', cleanUsername + ')');


            // Hide content area and spinner immediately when triggered
            if (statsContent) {
                statsContent.style.display = 'none';
                 console.log('Hiding statsContent.');
            }
             if (loadingSpinner) {
                 loadingSpinner.style.display = 'none';
                  console.log('Hiding spinner.');
             }


            if (!cleanUsername) {
                console.warn("Username is empty after trimming, skipping update.");
                if (currentUsernameSpan) {
                   currentUsernameSpan.textContent = "[Tyhjä]";
                }
                 // Clear loaded images/links within statsContent when username is cleared
                 document.querySelectorAll('#statsContent img[src], #statsContent a[href]:not(.back-to-top)').forEach(element => {
                      if (element.tagName === 'IMG' && element.hasAttribute('data-src')) {
                          element.removeAttribute('src'); // Remove src to hide image
                           console.log('Cleared src for image:', element.getAttribute('data-src'));
                      } else if (element.tagName === 'A' && element.hasAttribute('data-href')) {
                          element.removeAttribute('href'); // Remove href for links
                           console.log('Cleared href for link:', element.getAttribute('data-href'));
                      }
                  });
                 // Remove last stored username if input is cleared
                 localStorage.removeItem('lastGeocacheUsername');
                 return; // Stop the function here
            }

            // Store successfully entered username
            localStorage.setItem('lastGeocacheUsername', cleanUsername);
             console.log('Stored username in localStorage:', cleanUsername);


            // Show content area and spinner when a valid username is entered
             if (statsContent) {
                 statsContent.style.display = 'block';
                  console.log('Showing statsContent.');
             }
            if (loadingSpinner) {
                loadingSpinner.style.display = 'block'; // Show spinner
                 console.log('Showing spinner.');
            }


            if (currentUsernameSpan) {
                currentUsernameSpan.textContent = cleanUsername;
                 console.log('Updated current username span:', cleanUsername);
            }

            // Select only dynamic elements within statsContent
            const elementsToUpdate = statsContent.querySelectorAll('img[data-src], a[data-href]');
            console.log('Found elements to update:', elementsToUpdate.length);

            const userParamRegex = /user=([^&]+)/;

            // Reset loading counter and ensure images are initially hidden before loading
            currentImagesLoading = 0;
            const imagesToLoad = statsContent.querySelectorAll('img[data-src]');
             console.log('Images potentially loading:', imagesToLoad.length);


             imagesToLoad.forEach(img => {
                 img.style.visibility = 'hidden';
                 img.style.opacity = '0';
                 // Remove old listeners to avoid double counting
                 img.removeEventListener('load', handleImageLoadError);
                 img.removeEventListener('error', handleImageLoadError);
                 console.log('Prepared image for loading:', img.getAttribute('data-src'));
             });


            elementsToUpdate.forEach(element => {
                let originalUrl;
                let urlAttribute;

                if (element.tagName === 'IMG' && element.hasAttribute('data-src')) {
                    originalUrl = element.getAttribute('data-src');
                    urlAttribute = 'src';

                    // Add to loading counter only for images
                    currentImagesLoading++;
                    console.log('Tracking image load:', originalUrl);


                    // Set listeners for loading and error
                     element.addEventListener('load', handleImageLoadError);
                     element.addEventListener('error', handleImageLoadError);


                } else if (element.tagName === 'A' && element.hasAttribute('data-href')) {
                    originalUrl = element.getAttribute('data-href');
                    urlAttribute = 'href';
                     console.log('Updating link href:', originalUrl);
                     // For links, no loading indicator logic needed here
                } else {
                    return; // Skip elements without data-src/data-href or other types
                }

                // Construct the new URL with the updated username
                if (originalUrl && originalUrl.includes('user=')) {
                    const newUrl = originalUrl.replace(userParamRegex, 'user=' + encodeURIComponent(cleanUsername));
                     // Set the src/href attribute to trigger loading/update
                    element[urlAttribute] = newUrl;
                     console.log('Set element attribute:', urlAttribute, newUrl);
                } else if (originalUrl && !element[urlAttribute]) {
                     // If the data attribute exists but doesn't contain 'user=' (like the PGC link),
                     // or if it's a link without 'user=' (like PGC checker), just set the attribute once if it's not already set.
                     element[urlAttribute] = originalUrl;
                      console.log('Set static element attribute:', urlAttribute, originalUrl);
                 }
            });

            // Check immediately if there were no images to load
             if (imagesToLoad.length === 0) {
                 console.log('No images to load, checking loading complete immediately.');
                 checkLoadingComplete();
             }


        }

         // Single handler for image load or error
        function handleImageLoadError() {
            console.log('Image load/error event:', this.getAttribute('data-src'));
            currentImagesLoading--;
             console.log('Images loading remaining:', currentImagesLoading);
            // Show the image regardless of success/failure
            this.style.visibility = 'visible';
            this.style.opacity = '1';
             // Clean up listeners
            this.removeEventListener('load', handleImageLoadError);
            this.removeEventListener('error', handleImageLoadError);
            checkLoadingComplete();
        }


        // Function to check if all images have loaded and hide spinner
        function checkLoadingComplete() {
             // Use a small delay to ensure DOM updates and potential subsequent loads register
             setTimeout(() => {
                 console.log('Checking loading complete. Remaining:', currentImagesLoading);
                 if (currentImagesLoading <= 0) {
                     if (loadingSpinner) {
                         loadingSpinner.style.display = 'none'; // Hide spinner
                         console.log('All images processed, hiding spinner.');
                     }
                 } else {
                      // Keep spinner visible if loading is ongoing
                     if (loadingSpinner && loadingSpinner.style.display === 'none') {
                          // Should not happen if logic is correct, but as safeguard
                         loadingSpinner.style.display = 'block';
                         console.log('Images still loading, showing spinner (safeguard). Remaining:', currentImagesLoading);
                     } else if (!loadingSpinner) {
                         console.warn('loadingSpinner element not found.');
                     }
                 }
             }, 50); // Short delay
        }


        // --- JavaScript for suggestions ---

        // Populate the suggestions dropdown
        function populateSuggestions() {
            console.log('Populating suggestions...');
            usernameSuggestionsDiv.innerHTML = ''; // Clear current suggestions
            if (suggestedUsernames.length === 0) {
                console.log('No suggested usernames defined.');
                return; // Do nothing if no suggestions
            }

            suggestedUsernames.forEach(name => {
                const suggestionSpan = document.createElement('span');
                suggestionSpan.textContent = name;
                suggestionSpan.addEventListener('click', () => {
                    console.log('Suggestion clicked:', name);
                    usernameInput.value = name;
                    usernameSuggestionsDiv.style.display = 'none'; // Hide suggestions
                    console.log('Input value set to:', name, 'Suggestions hidden.');
                    // KORJAUS: Kutsu updateStats heti kun nimi valitaan alasvetovalikosta
                    updateStats(name);
                    // Poistettu usernameInput.focus() kutsu välttääksesi uudelleenfocusoinnista johtuvia ongelmia blur-timerin kanssa
                });
                usernameSuggestionsDiv.appendChild(suggestionSpan);
            });
             console.log('Suggestions populated.');
        }

        // Event listeners for suggestions
        usernameInput.addEventListener('focus', () => {
            console.log('Input focused.');
             if (suggestedUsernames.length > 0 && usernameSuggestionsDiv.children.length > 0) { // Check if there are suggestions to show
                 usernameSuggestionsDiv.style.display = 'block'; // Show suggestions on focus
                 console.log('Showing suggestions.');
             }
        });

         // Hide suggestions when input loses focus, with a small delay
         // to allow clicking on a suggestion before it disappears
        usernameInput.addEventListener('blur', () => {
            console.log('Input blurred. Setting hide timeout.');
            // KORJAUS: Kasvatettu timeoutin viivettä
            setTimeout(() => {
                 // Tarkista vielä, onko fokus palannut kenttään timeoutin aikana (ei pitäisi tapahtua, mutta varmuuden vuoksi)
                 if (document.activeElement !== usernameInput) {
                    usernameSuggestionsDiv.style.display = 'none';
                    console.log('Hiding suggestions after blur timeout.');
                 } else {
                     console.log('Focus returned to input during blur timeout, not hiding suggestions.');
                 }
            // KORJAUS: Timeout 200ms -> 300ms tai enemmän tarvittaessa
            }, 200); // Adjusted delay (was 100)
        });


        // --- Event Listeners ---

        // Event listener for the button click
        updateButton.addEventListener('click', () => {
            console.log('Update button clicked.');
            const username = usernameInput.value; // Get value from input field
            updateStats(username); // Call the update function
        });

        // Event listener for the input field (Enter key)
        usernameInput.addEventListener('keypress', (event) => {
            // Check if the pressed key is Enter
            if (event.key === 'Enter') {
                console.log('Enter key pressed in input.');
                event.preventDefault(); // Prevent default form submission if any
                const username = usernameInput.value; // Get value from input field
                updateStats(username); // Call the update function
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event fired.');
            // Adjust layout initially. This sets fixed positions and padding.
            adjustLayout();

            // Populate suggestions on load
            populateSuggestions();

            // Check for last username in localStorage on load
            const lastUsername = localStorage.getItem('lastGeocacheUsername');
            if (lastUsername) {
                console.log('Found last username in localStorage:', lastUsername);
                usernameInput.value = lastUsername;
                // Trigger updateStats if a last username was found to load stats immediately
                updateStats(lastUsername);
            } else {
                console.log('No last username found in localStorage.');
                // Ensure statsContent is hidden if no last username was loaded
                 if (statsContent) {
                     statsContent.style.display = 'none';
                 }
                if (currentUsernameSpan) {
                   currentUsernameSpan.textContent = "[Ei käyttäjää]";
                }
            }

        });

        // Adjust layout on window resize
        window.addEventListener('resize', adjustLayout);
        console.log('Resize listener added.');


    </script>

</body>
</html>
