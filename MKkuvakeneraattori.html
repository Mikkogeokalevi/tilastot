<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Kätkö tilastojen - Kuvageneraattori</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSBHRFCKEP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LSBHRFCKEP');
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      /* Oletus (Tumma/Sininen) teema */
      --bg-color: #1e1e2e;
      --text-color: #cdd6f4;
      --card-bg: #313244;
      --border-color: #45475a;
      --accent-color: #89b4fa;
      --button-bg: #585b70;
      --button-hover-bg: #6c7086;
      --link-color: #89b4fa;
      --link-hover-color: #a6e3a1;
      --placeholder-color: #a0a0a0;
      --disabled-bg-color: #2a2a3a;
      --disabled-text-color: #888;

      --border-radius: 8px;
      --spacing-small: 0.5em;
      --spacing-medium: 1em;
      --spacing-large: 1.5em;
      --spacing-mobile-small: 0.3em;
      --spacing-mobile-medium: 0.8em;
      --spacing-mobile-large: 1em;
    }

    /* Vihreä (Maasto) teema */
    .theme-green {
      --bg-color: #283618;
      --text-color: #fefae0;
      --card-bg: #3a5a40;
      --border-color: #588157;
      --accent-color: #a3b18a;
      --button-bg: #588157;
      --button-hover-bg: #3a5a40;
      --link-color: #a3b18a;
      --link-hover-color: #dda15e;
      --placeholder-color: #dad7cd;
      --disabled-bg-color: #2f3e24;
      --disabled-text-color: #a3b18a;
    }

    /* Keltainen (Kevät) teema */
    .theme-yellow {
      --bg-color: #fffbe6; 
      --text-color: #576000; 
      --card-bg: #fef9c3;   
      --border-color: #fde047; 
      --accent-color: #a3bf58; 
      --button-bg: #fde047;   
      --button-hover-bg: #facc15; 
      --link-color: #a3bf58;
      --link-hover-color: #84cc16;
      --placeholder-color: #a1a1aa;
      --disabled-bg-color: #fef9e7;
      --disabled-text-color: #b0b08c;
    }
    .theme-yellow select, .theme-yellow input[type="date"], .theme-yellow input[type="text"],
    .theme-yellow #regionListContainer, .theme-yellow #paikkakuntaSelectorModal {
        background-color: #fffce8; 
        color: var(--text-color); 
        border: 1px solid var(--border-color);
    }
    .theme-yellow .modal-content li:hover {
        background-color: #fef08a; 
    }
     .theme-yellow #locationFilterValue:disabled {
        background-color: #fef9e7;
        color: var(--disabled-text-color);
    }


    /* Punainen teema */
    .theme-red {
      --bg-color: #40000D;
      --text-color: #ffe5e5;
      --card-bg: #60001B;
      --border-color: #A0002B;
      --accent-color: #ff6666;
      --button-bg: #A0002B;
      --button-hover-bg: #800022;
      --link-color: #ff6666;
      --link-hover-color: #ff8c8c;
      --placeholder-color: #f0c0c0;
      --disabled-bg-color: #500014;
      --disabled-text-color: #ccaaaa;
    }

    /* Ruskea teema */
    .theme-brown {
      --bg-color: #3d2b1f;
      --text-color: #f5f5dc;
      --card-bg: #5a3d2b;
      --border-color: #7b5b3f;
      --accent-color: #c8a070;
      --button-bg: #7b5b3f;
      --button-hover-bg: #5a3d2b;
      --link-color: #c8a070;
      --link-hover-color: #e0b98c;
      --placeholder-color: #d3c0b1;
      --disabled-bg-color: #4a3528;
      --disabled-text-color: #bca593;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: var(--spacing-medium);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 600px;
      margin: var(--spacing-large) auto;
      padding: var(--spacing-large);
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s;
    }

    .header-area {
        display: flex;
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: var(--spacing-large); 
        padding-bottom: var(--spacing-medium);
        border-bottom: 1px solid var(--border-color);
        transition: border-color 0.3s;
        flex-wrap: wrap; 
    }
    
    .header-title-area { 
        display: flex;
        align-items: center;
    }

    .header-area .logo {
        width: 60px; 
        height: 60px;
        margin-right: var(--spacing-medium);
        border: none;
        flex-shrink: 0;
        border-radius: var(--border-radius);
    }

    .header-area h2 {
        margin: 0;
        font-size: 1.6em; 
        color: var(--text-color);
    }
    
    #themeSelectorContainer {
        display: flex; 
        align-items: center; 
        margin-top: var(--spacing-small); 
    }
    #themeSelectorContainer label {
        margin-right: var(--spacing-small);
        margin-top:0;
        margin-bottom: 0;
        font-size: 0.8em; 
        font-weight: normal; 
    }

    #themeSelector {
        padding: 0.3em 0.5em; 
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        background-color: var(--button-bg); 
        color: var(--text-color);
        font-size: 0.8em; 
        width: auto; 
        margin-bottom: 0; 
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    label {
      display: inline-block;
      margin-bottom: var(--spacing-small);
      margin-top: var(--spacing-medium);
      font-weight: bold;
    }

    select, input[type="date"], input[type="text"] {
      width: calc(100% - 1em);
      padding: var(--spacing-small);
      margin-bottom: var(--spacing-medium);
      border: 1px solid var(--border-color); 
      border-radius: var(--border-radius);
      background-color: var(--bg-color); 
      color: var(--text-color); 
      font-size: 1em;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    select#themeSelector { /* Varmistetaan, että teemavalitsin ei peri tätä yleistä leveyttä */
        width: auto;
    }


     select:focus, input[type="date"]:focus, input[type="text"]:focus {
        outline: none;
        border-color: var(--accent-color); 
        box-shadow: 0 0 5px var(--accent-color); 
     }

    .row {
      display: flex;
      gap: var(--spacing-small);
      flex-wrap: wrap;
      width: 100%;
      margin-bottom: var(--spacing-medium);
    }

    .row > div {
      flex: 1;
      min-width: 100px;
    }

    button, .modal-button { /* Yleiset nappityylit */
      margin-top: var(--spacing-medium);
      padding: var(--spacing-small) var(--spacing-medium);
      background-color: var(--button-bg); 
      color: var(--text-color); 
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.1em;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    button:hover, .modal-button:hover {
      background-color: var(--button-hover-bg); 
    }

    /* Nappien ryhmittely kuvatuloksen alla */
    .output-actions {
        display: flex;
        gap: var(--spacing-small);
        flex-wrap: wrap; /* Rivitä tarvittaessa pienillä näytöillä */
        margin-top: var(--spacing-medium);
    }
    .output-actions button, .output-actions a {
        flex-grow: 1; /* Jaa tilaa tasaisesti */
        margin-top: 0; /* Poista yksittäisten nappien ylämarginaali, koska wrapperilla on */
        text-align: center; /* Varmista tekstin keskitys linkissä */
        font-size: 0.9em; /* Hieman pienempi fontti näille napeille */
        padding: var(--spacing-small) var(--spacing-small); /* Yhtenäinen padding */
    }
     .output-actions a#linkki { /* Linkki-nappi */
        background-color: var(--button-bg);
        color: var(--text-color);
        border-radius: var(--border-radius);
        display: inline-flex; /* Jotta padding ja keskitys toimii paremmin */
        align-items: center;
        justify-content: center;
        line-height: normal; /* Palauta normaali riviväli */
    }
    .output-actions a#linkki:hover {
        background-color: var(--button-hover-bg);
        text-decoration: none; /* Poista alleviivaus hoverissa, koska se on nappi */
    }


    a { /* Yleinen linkkityyli, joka ei ole nappi */
      color: var(--link-color); 
      text-decoration: none;
      transition: color 0.3s ease;
    }
    a:not(.output-actions a):hover { /* Vain ei-nappimaisille linkeille */
        color: var(--link-hover-color); 
        text-decoration: underline;
    }

    .image-wrapper {
        position: relative;
        display: none; 
        margin-top: var(--spacing-medium);
        max-width: 100%;
        text-align: center;
    }

    .image-wrapper #kuva {
        display: block;
        max-width: 100%;
        height: auto;
        border: 1px solid var(--border-color); 
        border-radius: var(--border-radius);
        cursor: default;
        margin: 0 auto;
        transition: border-color 0.3s;
    }

    #map-overlay {
        display: none; 
        text-align: center;
        color: var(--text-color); 
        font-size: 0.9em;
        margin-bottom: var(--spacing-small);
    }

    #yearSpecificFilters {
        display: none;
        margin-top: var(--spacing-medium);
        padding-top: var(--spacing-medium);
        border-top: 1px solid var(--border-color); 
        transition: border-color 0.3s;
    }

    #locationFilterValue:disabled {
        background-color: var(--disabled-bg-color); 
        cursor: not-allowed;
        color: var(--disabled-text-color); 
    }

    input::placeholder {
      color: var(--placeholder-color); 
      opacity: 1;
    }

    .user-input-container {
        display: flex;
        align-items: flex-end;
        gap: var(--spacing-small);
         margin-bottom: var(--spacing-small); /* Muutettu pienemmäksi, jotta profiililinkille jää tilaa */
    }

    .user-input-container input[type="text"]#user {
         flex-grow: 1; 
         width: auto; 
         margin-bottom: 0; 
    }

    #resetButton {
        padding: var(--spacing-small) 0.8em; /* Säädetty padding */
        font-size: 1em; 
        /* height: calc(1em + 2 * var(--spacing-small) + 2 * 1px); Poistettu kiinteä korkeus, anna paddingin määrittää */
        line-height: 1.4; /* Varmistaa tekstin pystysuuntaisen keskityksen paremmin */
        margin-top: 0; 
        flex-shrink: 0; 
    }

    .location-input-icon-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-small);
    }

    .location-input-icon-container input[type="text"] {
        flex-grow: 1;
         width: auto;
         margin-bottom: 0;
    }

    .info-icon, #paikkakuntaSelectIcon { 
        cursor: pointer;
        color: var(--accent-color); 
        font-weight: bold;
        font-size: 1.1em; 
        padding: 0 0.3em;
        flex-shrink: 0;
        display: none; 
        user-select: none;
    }

    #regionListContainer {
        border: 1px solid var(--border-color); 
        border-radius: var(--border-radius);
        padding: var(--spacing-small);
        margin-top: var(--spacing-small);
        max-height: 150px;
        overflow-y: auto;
        background-color: var(--card-bg); 
        z-index: 10; 
        position: relative;
        font-size: 0.9em;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .region-list-item {
        padding: var(--spacing-mobile-small);
        cursor: pointer;
    }
    .region-list-item:hover {
        background-color: var(--button-hover-bg); 
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6); 
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    #paikkakuntaSelectorModal {
        background-color: var(--card-bg); 
        padding: var(--spacing-large);
        border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s;
    }
    .modal-header {
        font-size: 1.2em;
        margin-bottom: var(--spacing-medium);
        border-bottom: 1px solid var(--border-color); 
        padding-bottom: var(--spacing-small);
        transition: border-color 0.3s;
    }
    .modal-content {
        overflow-y: auto;
        margin-bottom: var(--spacing-medium);
        flex-grow: 1; 
    }
    .modal-content ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .modal-content li {
        padding: var(--spacing-small) 0;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color); 
        transition: border-color 0.3s;
    }
    .modal-content li:last-child {
        border-bottom: none;
    }
    .modal-content li:hover {
        background-color: var(--button-hover-bg); 
    }
    .modal-content .municipality-item label {
        display: flex; 
        align-items: center; 
        cursor: pointer;
        font-weight: normal; 
        margin-top: 0;
        margin-bottom: var(--spacing-small);
    }
     .modal-content .municipality-item input[type="checkbox"] {
        width: auto; 
        margin-right: var(--spacing-small); 
        margin-bottom: 0;
    }
    .modal-footer {
        display: flex;
        justify-content: space-between; 
        gap: var(--spacing-small);
        flex-wrap: wrap; 
    }
    .modal-button { 
        font-size: 0.9em; 
        margin-top: 0; 
    }

    #profileLinkContainer {
        min-height: 1.5em; /* Varmistetaan tilaa, ettei layout hyppää */
        margin-bottom: var(--spacing-medium);
        font-size: 0.9em;
    }
    #profileLink {
        display: inline-block; /* Antaa paddingin ja marginin toimia */
        padding: 0.2em 0.5em;
        border-radius: var(--border-radius);
        background-color: rgba(var(--accent-color-rgb), 0.1); /* Hieman vaaleampi tausta linkille */
        color: var(--accent-color);
        transition: background-color 0.2s, color 0.2s;
    }
    #profileLink:hover {
        background-color: rgba(var(--accent-color-rgb), 0.2);
        color: var(--link-hover-color);
    }


    @media (max-width: 700px) { 
        .header-area {
            flex-direction: column; 
            align-items: flex-start; 
        }
        .header-title-area {
            margin-bottom: var(--spacing-small); 
        }
        #themeSelectorContainer {
            margin-left: 0; 
            width: 100%; 
            justify-content: flex-start; 
        }
    }

    @media (max-width: 600px) {
        body { margin: var(--spacing-mobile-medium); }
        .container {
            padding: var(--spacing-mobile-large);
            margin: var(--spacing-mobile-large) auto;
        }
        .header-area .logo {
            width: 50px; height: 50px;
            margin-bottom: var(--spacing-mobile-small); 
        }
        .header-area h2 { font-size: 1.4em; }
        #themeSelectorContainer label { font-size: 0.75em; }
        #themeSelector { font-size: 0.75em; padding: 0.2em 0.4em;}

        label { margin-top: var(--spacing-mobile-medium); margin-bottom: var(--spacing-mobile-small); }
        select, input[type="date"], input[type="text"] { margin-bottom: var(--spacing-mobile-medium); padding: var(--spacing-mobile-small); }
        select#themeSelector {
            width: auto;
        }

        #aikaKentat > .row {
             flex-direction: row; flex-wrap: wrap;
             gap: var(--spacing-mobile-small);
             margin-bottom: var(--spacing-mobile-small);
        }
        #aikaKentat > .row > div {
            min-width: 0; flex: 1 1 calc(50% - var(--spacing-mobile-small) / 2);
        }

         .row:not(#aikaKentat > .row) {
             flex-direction: column;
             gap: var(--spacing-mobile-medium);
             margin-bottom: var(--spacing-mobile-medium);
         }
         .row:not(#aikaKentat > .row) > div { min-width: 100%; }

        /* Mobiilisäädöt käyttäjänimikentälle ja Nollaa-napille */
        .user-input-container {
            /* display: flex; on oletuksena jo yllä */
            /* align-items: flex-end; on oletuksena jo yllä */
            gap: var(--spacing-mobile-small); 
        }
        .user-input-container input[type="text"]#user {
             /* flex-grow: 1; periytyy */
        }
        #resetButton {
             padding: var(--spacing-mobile-small) 0.6em; 
             font-size: 0.85em; /* Pienennetty fonttikokoa mobiilissa */
             height: auto; 
             line-height: 1.3; /* Säädetty riviväliä */
             white-space: nowrap; /* Estä tekstin rivittyminen napissa */
        }

         .location-input-icon-container {
             flex-direction: row; 
             align-items: center;
             gap: var(--spacing-mobile-small);
             margin-bottom: var(--spacing-mobile-medium);
         }
          .location-input-icon-container input[type="text"] {
              width: auto; flex-grow: 1;
          }
          .info-icon, #paikkakuntaSelectIcon {
              align-self: center; margin-bottom: 0;
               width: auto;
          }

          #regionListContainer {
              max-height: 100px;
              padding: var(--spacing-mobile-small);
              margin-top: var(--spacing-mobile-small);
         }
        #paikkakuntaSelectorModal {
            width: 95%;
            padding: var(--spacing-medium);
        }
        .modal-footer {
            justify-content: center; 
        }
        .modal-footer .modal-button {
            flex-basis: 100%; 
            margin-bottom: var(--spacing-small); 
        }
         .modal-footer .modal-button:last-child {
            margin-bottom: 0;
        }
        .output-actions { /* Varmista, että nämä napit rivittyvät mobiilissa */
            flex-direction: column;
        }
        .output-actions button, .output-actions a {
            width: 100%; /* Täysi leveys mobiilissa */
            margin-bottom: var(--spacing-mobile-small);
        }
         .output-actions > *:last-child {
            margin-bottom: 0;
        }
        #profileLinkContainer {
            margin-top: var(--spacing-mobile-small);
            margin-bottom: var(--spacing-mobile-medium);
        }


        button { margin-top: var(--spacing-mobile-medium); padding: var(--spacing-mobile-small) var(--spacing-mobile-medium); }
         /* Yleinen button leveys 100% mobiilissa, paitsi jos se on flex-item kuten #resetButton */
        button:not(#resetButton):not(.modal-button):not(#copyLinkButton) {
            width: 100%;
        }
        /* Kopioi ja Lataa -napeille myös täysi leveys mobiilissa, jos eivät output-actions sisällä */
        #copyLinkButton {
            width: 100%; /* Tämä on jo .output-actions alla, mutta varmistus */
        }
    }
  </style>
</head>
<body> 
  <div class="container">
    <div class="header-area">
        <div class="header-title-area">
            <img src="mikkokalevi.png" alt="Sivuston logo" class="logo">
            <h2>Kätkö tilastojen - Kuvageneraattori</h2>
        </div>
        <div id="themeSelectorContainer">
            <label for="themeSelector">Teema:</label>
            <select id="themeSelector">
                <option value="default">Oletus</option>
                <option value="theme-green">Vihreä</option>
                <option value="theme-yellow">Keltainen</option>
                <option value="theme-red">Punainen</option>
                <option value="theme-brown">Ruskea</option>
            </select>
        </div>
    </div>

    <label for="user">Käyttäjätunnus:</label>
    <div class="user-input-container">
        <input type="text" id="user" list="userlist" placeholder="esim. mikkokalevi">
        <datalist id="userlist">
          <option value="mikkokalevi">
          <option value="Tiltu">
          <option value="lahjemies">
          <option value="eukka">
          <option value="milde04">
          <option value="mkivimaki">
        </datalist>
         <button id="resetButton" type="button">Nollaa</button>
    </div>
    
    <div id="profileLinkContainer"></div> <label for="kuvatyyppi">Kuvan tyyppi:</label>
    <select id="kuvatyyppi">
      <option value="matrix">T/D-taulukko</option>
      <option value="kunta">Kuntakartta</option>
      <option value="year">Vuosikalenteri</option>
      <option value="ftfkunta">FTF kuntakartta</option>
      <option value="hiddenday">Jasmer</option>
      <option value="saari">saarilöydöt</option>
    </select>

    <label for="aikavalinta">Aikarajaus:</label>
    <select id="aikavalinta" onchange="toggleAikaKentat()">
      <option value="ei">Ei aikarajausta</option>
      <option value="kylla">Valitse aikaväli</option>
    </select>

    <div id="aikaKentat" style="display:none;">
      <div class="row">
        <div>
          <label for="year">Vuosi:</label>
          <select id="year">
            <option value="current">—</option>
          </select>
        </div>
        <div>
          <label for="month">Kuukausi:</label>
          <select id="month">
            <option value="current">—</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="startdate">Alkupäivä:</label>
          <input type="date" id="startdate">
        </div>
        <div>
          <label for="enddate">Loppupäivä:</label>
          <input type="date" id="enddate">
        </div>
      </div>
    </div>

    <label for="cachetype">Kätkötyyppi:</label>
    <select id="cachetype">
      <option value="">—</option>
      <option value="1">Traditional Cache</option>
      <option value="2">Multi-cache</option>
      <option value="3">Unknown Cache</option>
      <option value="4">Letterbox Hybrid</option>
      <option value="5">Event Cache</option>
      <option value="6">Earthcache</option>
      <option value="7">Virtual Cache</option>
      <option value="8">Webcam Cache</option>
      <option value="9">Wherigo Cache</option>
      <option value="10">Community Celebration Event</option>
      <option value="11">Mega-Event Cache</option>
      <option value="12">Cache In Trash Out Event</option>
      <option value="13">Giga-Event Cache</option>
      <option value="14">Groundspeak Block Party</option>
      <option value="98">Muut paitsi tradit</option>
      <option value="99">Kaikki event-tyypit</option>
      </select>

    <div id="yearSpecificFilters">
        <label>Vuosikalenterin lisäsuodatus:</label>
        <div class="row">
            <div>
                <label for="pkuntaMkuntaChoice">Sijainnin tyyppi:</label>
                <select id="pkuntaMkuntaChoice">
                    <option value="none">Ei rajoitusta</option>
                    <option value="pkunta">Paikkakunta</option>
                    <option value="mkunta">Maakunta</option>
                </select>
            </div>
            <div>
                 <label for="locationFilterValue">Nimi (pilkulla erotettuna):</label>
                 <div class="location-input-icon-container">
                     <input type="text" id="locationFilterValue" disabled placeholder="">
                     <span id="regionInfoIcon" class="info-icon" title="Näytä maakunnat">ⓘ</span>
                     <span id="paikkakuntaSelectIcon" class="info-icon" title="Valitse paikkakunnat työkalulla">⚙️</span>
                 </div>
                 <div id="regionListContainer" style="display: none;"></div>
            </div>
        </div>
         <div class="row">
             <div>
                  <label for="extraFilter">Lisäsuodatus:</label>
                  <select id="extraFilter">
                      <option value="">—</option>
                      <option value="1">Vain FTF-löydöt</option>
                      <option value="2">Vain haastekätköt</option>
                      <option value="3">Vain haastekätköjen FTF-löydöt</option>
                  </select>
             </div>
              <div></div>
         </div>
    </div>
    <button onclick="luoLinkki()">Luo linkki ja kuva</button>

    <div class="image-wrapper">
      <div id="map-overlay">Klikkaa karttaa isommaksi</div>
      <img id="kuva" alt="">
    </div>

    <div class="output-actions"> <a id="linkki" href="#" target="_blank">Avaa kuva uudessa ikkunassa</a>
        <button id="copyLinkButton" type="button">Kopioi linkki</button>
    </div>

  </div>

  <div id="paikkakuntaModalOverlay" class="modal-overlay">
    <div id="paikkakuntaSelectorModal">
        <div class="modal-header" id="modalHeaderText">Valitse maakunta</div>
        <div class="modal-content">
            <ul id="modalRegionList">
            </ul>
            <div id="modalMunicipalityListContainer" style="display:none;">
                <div class="municipality-item">
                     <label><input type="checkbox" id="selectAllMunicipalities"> Valitse kaikki / Poista valinnat</label>
                </div>
                <ul id="modalMunicipalityList">
                </ul>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="modalBackButton" class="modal-button" style="display:none;">&laquo; Takaisin maakuntiin</button>
            <button type="button" id="modalAddButton" class="modal-button" style="display:none;">Lisää valitut</button>
            <button type="button" id="modalCloseButton" class="modal-button">Sulje</button>
        </div>
    </div>
  </div>

  <script>
    // Copyright (c) 2025 mikkokalevi
    const userIds = {
        "mikkokalevi": 306478, "eukka": 36206, "Tiltu": 309395, "lahjemies": 308779, "milde04": 29523, "mkivimaki": 134775
    };
    const tripletOptionData = { value: '90', text: 'Triplet-extra: tradi, multi, mysse löydöt' };

    const suomenMaakunnat = [
        "Ahvenanmaa", "Etelä-Karjala", "Etelä-Pohjanmaa", "Etelä-Savo", "Kainuu", "Kanta-Häme", 
        "Keski-Pohjanmaa", "Keski-Suomi", "Kymenlaakso", "Lappi", "Pirkanmaa", "Pohjanmaa", 
        "Pohjois-Karjala", "Pohjois-Pohjanmaa", "Pohjois-Savo", "Päijät-Häme", "Satakunta", 
        "Uusimaa", "Varsinais-Suomi"
    ].sort();

    const maakuntienKunnat = {
        "Ahvenanmaa": ["Brändö", "Eckerö", "Finström", "Föglö", "Geta", "Hammarland", "Jomala", "Kumlinge", "Kökar", "Lemland", "Lumparland", "Maarianhamina", "Saltvik", "Sottunga", "Sund", "Vårdö"].sort(),
        "Etelä-Karjala": ["Imatra", "Lappeenranta", "Lemi", "Luumäki", "Parikkala", "Rautjärvi", "Ruokolahti", "Savitaipale", "Taipalsaari"].sort(),
        "Etelä-Pohjanmaa": ["Alajärvi", "Alavus", "Evijärvi", "Ilmajoki", "Isojoki", "Isokyrö", "Karijoki", "Kauhajoki", "Kauhava", "Kuortane", "Kurikka", "Lappajärvi", "Lapua", "Seinäjoki", "Soini", "Teuva", "Vimpeli", "Ähtäri"].sort(),
        "Etelä-Savo": ["Enonkoski", "Hirvensalmi", "Juva", "Kangasniemi", "Mikkeli", "Mäntyharju", "Pieksämäki", "Puumala", "Rantasalmi", "Savonlinna", "Sulkava"].sort(),
        "Kainuu": ["Hyrynsalmi", "Kajaani", "Kuhmo", "Paltamo", "Puolanka", "Ristijärvi", "Sotkamo", "Suomussalmi"].sort(),
        "Kanta-Häme": ["Forssa", "Hattula", "Hausjärvi", "Humppila", "Hämeenlinna", "Janakkala", "Jokioinen", "Loppi", "Riihimäki", "Tammela", "Ypäjä"].sort(),
        "Keski-Pohjanmaa": ["Halsua", "Kannus", "Kaustinen", "Kokkola", "Lestijärvi", "Perho", "Toholampi", "Veteli"].sort(),
        "Keski-Suomi": ["Hankasalmi", "Joutsa", "Jyväskylä", "Jämsä", "Kannonkoski", "Karstula", "Keuruu", "Kinnula", "Kivijärvi", "Konnevesi", "Kuhmoinen", "Kyyjärvi", "Laukaa", "Luhanka", "Multia", "Muurame", "Petäjävesi", "Pihtipudas", "Saarijärvi", "Toivakka", "Uurainen", "Viitasaari", "Äänekoski"].sort(),
        "Kymenlaakso": ["Hamina", "Kotka", "Kouvola", "Miehikkälä", "Pyhtää", "Virolahti"].sort(),
        "Lappi": ["Enontekiö", "Inari", "Kemi", "Kemijärvi", "Keminmaa", "Kittilä", "Kolari", "Muonio", "Pelkosenniemi", "Pello", "Posio", "Ranua", "Rovaniemi", "Salla", "Savukoski", "Simo", "Sodankylä", "Tervola", "Tornio", "Utsjoki", "Ylitornio"].sort(),
        "Pirkanmaa": ["Akaa", "Hämeenkyrö", "Ikaalinen", "Juupajoki", "Kangasala", "Kihniö", "Lempäälä", "Mänttä-Vilppula", "Nokia", "Orivesi", "Parkano", "Pirkkala", "Punkalaidun", "Pälkäne", "Ruovesi", "Sastamala", "Tampere", "Urjala", "Valkeakoski", "Vesilahti", "Virrat", "Ylöjärvi"].sort(),
        "Pohjanmaa": ["Kaskinen", "Korsnäs", "Kristiinankaupunki", "Kruunupyy", "Laihia", "Luoto", "Maalahti", "Mustasaari", "Närpiö", "Pedersöre", "Pietarsaari", "Uusikaarlepyy", "Vaasa", "Vöyri"].sort(),
        "Pohjois-Karjala": ["Heinävesi", "Ilomantsi", "Joensuu", "Juuka", "Kitee", "Kontiolahti", "Lieksa", "Liperi", "Nurmes", "Outokumpu", "Polvijärvi", "Rääkkylä", "Tohmajärvi"].sort(),
        "Pohjois-Pohjanmaa": ["Alavieska", "Haapajärvi", "Haapavesi", "Hailuoto", "Ii", "Kalajoki", "Kärsämäki", "Kempele", "Kuusamo", "Liminka", "Lumijoki", "Merijärvi", "Muhos", "Nivala", "Oulainen", "Oulu", "Pudasjärvi", "Pyhäjoki", "Pyhäjärvi", "Pyhäntä", "Raahe", "Reisjärvi", "Sievi", "Siikajoki", "Siikalatva", "Taivalkoski", "Tyrnävä", "Utajärvi", "Vaala", "Ylivieska"].sort(),
        "Pohjois-Savo": ["Iisalmi", "Joroinen", "Kaavi", "Keitele", "Kiuruvesi", "Kuopio", "Lapinlahti", "Leppävirta", "Pielavesi", "Rautalampi", "Rautavaara", "Siilinjärvi", "Sonkajärvi", "Suonenjoki", "Tervo", "Tuusniemi", "Varkaus", "Vesanto", "Vieremä"].sort(),
        "Päijät-Häme": ["Asikkala", "Hartola", "Heinola", "Hollola", "Iitti", "Kärkölä", "Lahti", "Orimattila", "Padasjoki", "Sysmä"].sort(),
        "Satakunta": ["Eura", "Eurajoki", "Harjavalta", "Huittinen", "Jämijärvi", "Kankaanpää", "Karvia", "Kokemäki", "Merikarvia", "Nakkila", "Pomarkku", "Pori", "Rauma", "Siikainen", "Säkylä", "Ulvila"].sort(),
        "Uusimaa": ["Askola", "Espoo", "Hanko", "Helsinki", "Hyvinkää", "Inkoo", "Järvenpää", "Karkkila", "Kauniainen", "Kerava", "Kirkkonummi", "Lapinjärvi", "Lohja", "Loviisa", "Myrskylä", "Mäntsälä", "Nurmijärvi", "Pornainen", "Porvoo", "Pukkila", "Raasepori", "Sipoo", "Siuntio", "Tuusula", "Vantaa", "Vihti"].sort(),
        "Varsinais-Suomi": ["Aura", "Kaarina", "Kemiönsaari", "Koski Tl", "Kustavi", "Laitila", "Lieto", "Loimaa", "Marttila", "Masku", "Mynämäki", "Naantali", "Nousiainen", "Oripää", "Paimio", "Parainen", "Pyhäranta", "Pöytyä", "Raisio", "Rusko", "Salo", "Sauvo", "Somero", "Taivassalo", "Turku", "Uusikaupunki", "Vehmaa"].sort()
    };

    function formatDate(input) {
      const parts = input.split("-");
      if (!parts || parts.length !== 3) return "";
      return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }

    function toggleAikaKentat() {
      const valinta = document.getElementById("aikavalinta")?.value || '';
      const aikaKentatDiv = document.getElementById("aikaKentat");
      if (aikaKentatDiv) aikaKentatDiv.style.display = valinta === "kylla" ? "block" : "none";
    }

    // Uusi funktio Geocaching-profiililinkin luomiseen ja näyttämiseen
    function updateGeocachingProfileLink() {
        const user = document.getElementById("user")?.value.trim();
        const profileLinkContainer = document.getElementById("profileLinkContainer");

        if (profileLinkContainer) {
            profileLinkContainer.innerHTML = ''; // Tyhjennetään edellinen linkki
            if (user) {
                const link = document.createElement('a');
                link.id = 'profileLink';
                link.href = `https://www.geocaching.com/p/?u=${encodeURIComponent(user)}`;
                link.target = '_blank';
                link.textContent = `Avaa ${user} profiili Geocaching.comissa`;
                profileLinkContainer.appendChild(link);
            }
        }
    }

    function applyTheme(themeName) {
        document.body.className = ''; 
        if (themeName !== 'default') {
            document.body.classList.add(themeName);
        }
        localStorage.setItem('selectedTheme', themeName);
        // Päivitä accent-color-rgb muuttuja dynaamisesti
        const computedStyle = getComputedStyle(document.body);
        const accentColor = computedStyle.getPropertyValue('--accent-color');
        // Poista '#' merkki ja muunna RGB-muotoon
        const hex = accentColor.startsWith('#') ? accentColor.slice(1) : accentColor;
        let r = 0, g = 0, b = 0;
        if (hex.length === 3) {
            r = parseInt(hex[0] + hex[0], 16);
            g = parseInt(hex[1] + hex[1], 16);
            b = parseInt(hex[2] + hex[2], 16);
        } else if (hex.length === 6) {
            r = parseInt(hex.substring(0, 2), 16);
            g = parseInt(hex.substring(2, 4), 16);
            b = parseInt(hex.substring(4, 6), 16);
        }
        document.body.style.setProperty('--accent-color-rgb', `${r},${g},${b}`);
    }

    function toggleYearSpecificFilters() {
        const kuvatyyppiSelect = document.getElementById("kuvatyyppi");
        const yearSpecificFiltersDiv = document.getElementById("yearSpecificFilters");
        const pkuntaMkuntaChoiceSelect = document.getElementById("pkuntaMkuntaChoice");
        const locationFilterValueInput = document.getElementById("locationFilterValue");
        const extraFilterSelect = document.getElementById("extraFilter");

        if (kuvatyyppiSelect.value === 'year') {
            yearSpecificFiltersDiv.style.display = 'block';
            handlePkuntaMkuntaChoice();
        } else {
            yearSpecificFiltersDiv.style.display = 'none';
            if (pkuntaMkuntaChoiceSelect) pkuntaMkuntaChoiceSelect.value = 'none';
            if (locationFilterValueInput) {
                locationFilterValueInput.value = '';
                locationFilterValueInput.disabled = true;
                locationFilterValueInput.placeholder = "";
            }
            if (extraFilterSelect) extraFilterSelect.value = '';
            const regionIcon = document.getElementById("regionInfoIcon");
            const paikkaIcon = document.getElementById("paikkakuntaSelectIcon");
            const regionList = document.getElementById("regionListContainer");
            if (regionIcon) regionIcon.style.display = 'none';
            if (paikkaIcon) paikkaIcon.style.display = 'none';
            if (regionList) regionList.style.display = 'none';
            closePaikkakuntaModal();
        }
    }

    function handlePkuntaMkuntaChoice() {
        const choiceSelect = document.getElementById("pkuntaMkuntaChoice");
        const locationInput = document.getElementById("locationFilterValue");
        const regionIcon = document.getElementById("regionInfoIcon");
        const paikkakuntaIcon = document.getElementById("paikkakuntaSelectIcon");
        const regionListDiv = document.getElementById("regionListContainer");

        locationInput.disabled = true;
        locationInput.placeholder = "";
        regionIcon.style.display = 'none';
        paikkakuntaIcon.style.display = 'none';
        if(regionListDiv) regionListDiv.style.display = 'none';
        closePaikkakuntaModal();

        const choice = choiceSelect.value;
        if (choice === 'pkunta') {
            locationInput.disabled = false;
            locationInput.placeholder = "esim. Lahti,Tampere (käytä ⚙️)";
            paikkakuntaIcon.style.display = 'inline-block';
        } else if (choice === 'mkunta') {
             locationInput.disabled = false;
             locationInput.placeholder = "esim. Päijät-Häme (käytä ⓘ)";
             regionIcon.style.display = 'inline-block';
        } else {
            locationInput.value = '';
        }
    }

    function toggleRegionList() {
         const regionListContainer = document.getElementById("regionListContainer");
         if (!regionListContainer) return;
         if (regionListContainer.style.display === 'block') {
             regionListContainer.style.display = 'none';
         } else {
             if (regionListContainer.childElementCount === 0) {
                 suomenMaakunnat.forEach(maakunta => {
                     const item = document.createElement('div');
                     item.textContent = maakunta;
                     item.classList.add('region-list-item');
                     item.addEventListener('click', function() {
                          const locInput = document.getElementById("locationFilterValue");
                          let currentVal = locInput.value.trim();
                          if (currentVal && !currentVal.endsWith(',')) {
                              currentVal += ',';
                          } 
                          locInput.value = currentVal + this.textContent;
                          locInput.focus();
                          toggleRegionList();
                     });
                     regionListContainer.appendChild(item);
                 });
             }
             regionListContainer.style.display = 'block';
         }
    }

    const modalOverlay = document.getElementById('paikkakuntaModalOverlay');
    const modalHeader = document.getElementById('modalHeaderText');
    const modalRegionUL = document.getElementById('modalRegionList');
    const modalMunListContainer = document.getElementById('modalMunicipalityListContainer');
    const modalMunUL = document.getElementById('modalMunicipalityList');
    const modalBackBtn = document.getElementById('modalBackButton');
    const modalAddBtn = document.getElementById('modalAddButton');
    const modalCloseBtn = document.getElementById('modalCloseButton');
    const paikkakuntaIconGlobal = document.getElementById('paikkakuntaSelectIcon');
    const selectAllMunCheckbox = document.getElementById('selectAllMunicipalities');

    function openPaikkakuntaModal() {
        if(modalOverlay) modalOverlay.style.display = 'flex';
        showModalRegionSelection();
    }
    function closePaikkakuntaModal() {
        if(modalOverlay) modalOverlay.style.display = 'none';
    }

    function showModalRegionSelection() {
        modalHeader.textContent = 'Valitse maakunta';
        modalRegionUL.innerHTML = '';
        modalMunListContainer.style.display = 'none';
        modalMunUL.innerHTML = ''; 
        modalBackBtn.style.display = 'none';
        modalAddBtn.style.display = 'none';
        if(selectAllMunCheckbox) selectAllMunCheckbox.checked = false;

        suomenMaakunnat.forEach(region => {
            if (maakuntienKunnat[region] && maakuntienKunnat[region].length > 0) {
                const li = document.createElement('li');
                li.textContent = region;
                li.addEventListener('click', () => showModalMunicipalitySelection(region));
                modalRegionUL.appendChild(li);
            }
        });
        modalRegionUL.style.display = 'block';
    }

    function showModalMunicipalitySelection(region) {
        modalHeader.textContent = `Valitse kunnat (${region})`;
        modalRegionUL.style.display = 'none';
        modalMunUL.innerHTML = '';
        if(selectAllMunCheckbox) selectAllMunCheckbox.checked = false;

        const municipalities = maakuntienKunnat[region] || [];
        municipalities.forEach(mun => {
            const li = document.createElement('li');
            li.classList.add('municipality-item');
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = mun;
            checkbox.name = 'modal_municipality';
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${mun}`));
            li.appendChild(label);
            modalMunUL.appendChild(li);
        });

        modalMunListContainer.style.display = 'block';
        modalBackBtn.style.display = 'inline-block';
        modalAddBtn.style.display = 'inline-block';
    }
    
    if(selectAllMunCheckbox) {
        selectAllMunCheckbox.addEventListener('change', function() {
            const checkboxes = modalMunUL.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        });
    }

    if(modalAddBtn) {
        modalAddBtn.addEventListener('click', () => {
            const locationInput = document.getElementById('locationFilterValue');
            const selectedMunicipalities = [];
            modalMunUL.querySelectorAll('input[name="modal_municipality"]:checked').forEach(cb => {
                selectedMunicipalities.push(cb.value);
            });

            if (selectedMunicipalities.length > 0) {
                let existingPaikkakunnatArray = locationInput.value.split(',')
                                                    .map(s => s.trim())
                                                    .filter(s => s); 
                
                const newUniqueMunicipalities = selectedMunicipalities.filter(item => !existingPaikkakunnatArray.includes(item));
                const combinedArray = existingPaikkakunnatArray.concat(newUniqueMunicipalities);
                
                locationInput.value = combinedArray.join(',');
            }
            showModalRegionSelection(); 
        });
    }

    if (paikkakuntaIconGlobal) paikkakuntaIconGlobal.addEventListener('click', openPaikkakuntaModal);
    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closePaikkakuntaModal);
    if (modalBackBtn) modalBackBtn.addEventListener('click', showModalRegionSelection);
    if (modalOverlay) modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closePaikkakuntaModal(); });

    function handleKuvatyyppiChange() {
        const kuvatyyppiSelect = document.getElementById("kuvatyyppi");
        const cachetypeSelect = document.getElementById("cachetype");
        if (!kuvatyyppiSelect || !cachetypeSelect) return;
        const selectedType = kuvatyyppiSelect.value;
        toggleAikaKentat();
        toggleYearSpecificFilters(); 

        const existingTripletOption = cachetypeSelect.querySelector(`option[value="${tripletOptionData.value}"]`);
        if (selectedType === 'kunta') {
            if (!existingTripletOption) {
                const opt = document.createElement("option");
                opt.value = tripletOptionData.value;
                opt.textContent = tripletOptionData.text;
                cachetypeSelect.appendChild(opt);
            }
        } else {
            if (existingTripletOption) {
                if (cachetypeSelect.value === tripletOptionData.value) cachetypeSelect.value = '';
                existingTripletOption.remove();
            }
        }
    }

    function luoLinkki() {
      const imageElement = document.getElementById("kuva");
      const linkElementBelow = document.getElementById("linkki");
      const overlayElement = document.getElementById("map-overlay");
      const imageWrapper = document.querySelector('.image-wrapper');
      const copyLinkButton = document.getElementById("copyLinkButton");

      imageWrapper.style.display = 'none'; 
      linkElementBelow.style.display = 'none';
      copyLinkButton.style.display = 'none';
      if(overlayElement) overlayElement.style.display = 'none';
      if(imageElement) imageElement.src = '';

      const baseUrl = "https://www.geocache.fi/stat/";
      const kuvatyyppi = document.getElementById("kuvatyyppi")?.value || '';
      const user = document.getElementById("user")?.value.trim() || '';
      const start = document.getElementById("startdate")?.value || '';
      const end = document.getElementById("enddate")?.value || '';
      const cachetype = document.getElementById("cachetype")?.value || '';
      const aikavalinta = document.getElementById("aikavalinta")?.value || '';
      const yearVal = document.getElementById("year")?.value || '';
      const monthVal = document.getElementById("month")?.value || '';
      const pkuntaMkuntaChoice = document.getElementById("pkuntaMkuntaChoice")?.value || '';
      const locationFilterValue = document.getElementById("locationFilterValue")?.value.trim() || '';
      const extraFilter = document.getElementById("extraFilter")?.value || '';

      if (!user) { alert("Syötä käyttäjänimi."); return; }

      let params = `?user=${encodeURIComponent(user)}`;
      if (kuvatyyppi === "hiddenday") params += `&type=2`;

      if (aikavalinta === "kylla") {
        if (start && end) {
           const formattedStart = formatDate(start);
           const formattedEnd = formatDate(end);
           if (formattedStart && formattedEnd) params += `&startdate=${formattedStart}&enddate=${formattedEnd}`;
           else { alert("Virheellinen päivämäärämuoto."); return; }
        } else {
          if (yearVal && yearVal !== "current") params += `&year=${yearVal}`;
          if (monthVal && monthVal !== "current") params += `&month=${monthVal}`;
        }
      }

      if (kuvatyyppi === "year") {
          if (locationFilterValue) {
              if (pkuntaMkuntaChoice === 'pkunta') params += `&pkunta=${encodeURIComponent(locationFilterValue)}`;
              else if (pkuntaMkuntaChoice === 'mkunta') params += `&mkunta=${encodeURIComponent(locationFilterValue)}`;
          }
          if (extraFilter) params += `&extra=${extraFilter}`;
      }

      if (cachetype) params += `&cachetype=${cachetype}`;

      const finalUrl = `${baseUrl}${kuvatyyppi}.php${params}`;
      let urlToCopy = finalUrl;
      const selectedUserId = userIds[user]; // Käytä suoraan käyttäjänimeä, jos userid on olemassa

      if (kuvatyyppi === "kunta" && selectedUserId) {
          let largeMapUrl = `${baseUrl}kunta/?userid=${selectedUserId}&names=1`;
          if (cachetype) largeMapUrl += `&cachetype=${cachetype}`;
          if (aikavalinta === "kylla" && !(start && end)) {
               if (yearVal && yearVal !== "current") largeMapUrl += `&year=${yearVal}`;
               if (monthVal && monthVal !== "current") largeMapUrl += `&month=${monthVal}`;
          }
          urlToCopy = largeMapUrl; // Kuntakartan tapauksessa kopioidaan isomman kartan linkki
          imageElement.src = finalUrl; // Pienempi esikatselukuva
          imageElement.alt = "Kuntakartta (klikkaa isompaan kuvaan)";
          imageElement.dataset.largeMapUrl = largeMapUrl;
          imageElement.style.cursor = 'pointer';
          linkElementBelow.style.display = 'none'; // Ei näytetä "Avaa uudessa ikkunassa" kun kartta on klikattava
          if(overlayElement) overlayElement.style.display = 'block';
      } else {
          if(imageElement) {
            imageElement.src = finalUrl;
            imageElement.alt = "Tilastokuva";
            delete imageElement.dataset.largeMapUrl;
            imageElement.style.cursor = 'default';
          }
          if(linkElementBelow) {
            linkElementBelow.href = finalUrl;
            linkElementBelow.style.display = 'inline-flex'; // inline-flex jotta padding toimii kuten napeissa
          }
          if(overlayElement) overlayElement.style.display = 'none';
      }

       if (finalUrl) {
            if(imageWrapper) imageWrapper.style.display = 'block';
            if(copyLinkButton) {
                copyLinkButton.style.display = 'inline-block';
                copyLinkButton.dataset.urlToCopy = urlToCopy; // Käytä mahdollisesti muokattua urlToCopy
            }
            const settingsToSave = {
                user, kuvatyyppi, aikavalinta, year: yearVal, month: monthVal, startdate: start, enddate: end, 
                cachetype, pkuntaMkuntaChoice, locationFilterValue, extraFilter
            };
            try { localStorage.setItem('statGeneratorSettings', JSON.stringify(settingsToSave)); } catch (e) { console.error(e); }
        } else {
            if(imageWrapper) imageWrapper.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const D = document;
        const id = (elId) => D.getElementById(elId);
        const userEl = id("user"), kuvatyyppiEl = id("kuvatyyppi"), aikavalintaEl = id("aikavalinta"),
              yearSel = id("year"), monthSel = id("month"), startdateEl = id("startdate"),
              enddateEl = id("enddate"), cachetypeEl = id("cachetype"), pkuntaMkuntaEl = id("pkuntaMkuntaChoice"),
              locationValEl = id("locationFilterValue"), extraFilterEl = id("extraFilter"),
              imgEl = id("kuva"), copyBtn = id("copyLinkButton"), imgWrapper = D.querySelector('.image-wrapper'),
              resetBtn = id("resetButton"), regionInfoIcn = id("regionInfoIcon"),
              themeSelector = id("themeSelector");

        if(themeSelector) {
            themeSelector.addEventListener('change', (e) => {
                applyTheme(e.target.value);
            });
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            applyTheme(savedTheme);
            themeSelector.value = savedTheme;
        }

        if (yearSel) {
            const currentY = new Date().getFullYear();
            yearSel.innerHTML = '<option value="current">—</option>';
            for (let y = 2000; y <= currentY; y++) yearSel.innerHTML += `<option value="${y}">${y}</option>`;
        }
        if (monthSel) {
            monthSel.innerHTML = '<option value="current">—</option>';
            const M = ["Tammi","Helmi","Maalis","Huhti","Touko","Kesä","Heinä","Elo","Syys","Loka","Marras","Joulu"];
            M.forEach((n, i) => monthSel.innerHTML += `<option value="${(i+1).toString().padStart(2,'0')}">${n}</option>`);
        }

        kuvatyyppiEl?.addEventListener('change', handleKuvatyyppiChange);
        aikavalintaEl?.addEventListener('change', toggleAikaKentat);
        pkuntaMkuntaEl?.addEventListener('change', handlePkuntaMkuntaChoice);
        imgEl?.addEventListener('click', function() { if(this.dataset.largeMapUrl) window.open(this.dataset.largeMapUrl, '_blank'); });
        copyBtn?.addEventListener('click', function() {
            if(this.dataset.urlToCopy) navigator.clipboard.writeText(this.dataset.urlToCopy)
                .then(() => { this.textContent = "Kopioitu!"; setTimeout(() => { this.textContent = "Kopioi linkki"; }, 2000); })
                .catch(() => { this.textContent = "Kopiointi epäonnistui!"; setTimeout(() => { this.textContent = "Kopioi linkki"; }, 3000); });
        });
        regionInfoIcn?.addEventListener('click', toggleRegionList);
        resetBtn?.addEventListener('click', () => {
            [userEl, startdateEl, enddateEl, locationValEl].forEach(el => el ? el.value = '' : null);
            [kuvatyyppiEl, aikavalintaEl, yearSel, monthSel, cachetypeEl, pkuntaMkuntaEl, extraFilterEl].forEach(sel => {
                if(sel) {
                    if (sel.id === 'year' || sel.id === 'month') sel.value = 'current';
                    else if (sel.id === 'kuvatyyppi') sel.value = 'matrix';
                    else if (sel.id === 'aikavalinta') sel.value = 'ei';
                    else if (sel.id === 'pkuntaMkuntaChoice') sel.value = 'none';
                    else sel.value = sel.options[0]?.value || '';
                }
            });
            try { localStorage.removeItem('statGeneratorSettings'); } catch (e) { console.error(e); }
            handleKuvatyyppiChange();
            if(imgWrapper) imgWrapper.style.display = 'none';
            const linkki = id("linkki");
            const copyNappi = id("copyLinkButton");
            if(linkki) linkki.style.display = 'none';
            if(copyNappi) copyNappi.style.display = 'none';
            closePaikkakuntaModal();
            updateGeocachingProfileLink(); // Päivitä profiililinkki myös nollauksen yhteydessä
        });

        // Kuuntele käyttäjätunnuskentän muutoksia ja datalistin valintoja
        userEl?.addEventListener('input', updateGeocachingProfileLink);
        userEl?.addEventListener('change', updateGeocachingProfileLink); // Valinta datalistista

        try {
            const saved = localStorage.getItem('statGeneratorSettings');
            if (saved) {
                const S = JSON.parse(saved);
                if(userEl && S.user !== undefined) userEl.value = S.user;
                if(kuvatyyppiEl && S.kuvatyyppi !== undefined) kuvatyyppiEl.value = S.kuvatyyppi;
                if(aikavalintaEl && S.aikavalinta !== undefined) aikavalintaEl.value = S.aikavalinta;
                if(yearSel && S.year !== undefined) yearSel.value = S.year;
                if(monthSel && S.month !== undefined) monthSel.value = S.month;
                if(startdateEl && S.startdate !== undefined) startdateEl.value = S.startdate;
                if(enddateEl && S.enddate !== undefined) enddateEl.value = S.enddate;
                if(pkuntaMkuntaEl && S.pkuntaMkuntaChoice !== undefined) pkuntaMkuntaEl.value = S.pkuntaMkuntaChoice;
                if(locationValEl && S.locationFilterValue !== undefined) locationValEl.value = S.locationFilterValue;
                if(extraFilterEl && S.extraFilter !== undefined) extraFilterEl.value = S.extraFilter;
                
                handleKuvatyyppiChange();
                if (cachetypeEl && S.cachetype !== undefined) {
                    let ct = S.cachetype;
                    if (ct && !cachetypeEl.querySelector(`option[value="${ct}"]`)) ct = '';
                    cachetypeEl.value = ct;
                }
                updateGeocachingProfileLink(); // Kutsu linkin päivitystä tallennettujen asetusten lataamisen jälkeen
            } else { 
                handleKuvatyyppiChange();
                updateGeocachingProfileLink(); // Kutsu linkin päivitystä, jos asetuksia ei löydy
            }
        } catch (e) { 
            console.error(e); 
            handleKuvatyyppiChange(); 
            updateGeocachingProfileLink(); // Varmista linkin päivitys virhetilanteessakin
        }
    });
  </script>
</body>
</html>
