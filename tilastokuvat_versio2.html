Nuo samat virheet kertovat edelleen siitä, että selaimen lataamassa tiedostossa funktioita luoLinkki ja handleKuvatyyppiChange ei löydy siitä paikasta (globaalista scope:sta), mistä HTML-attribuutit (onclick, onchange) niitä yrittävät kutsua.

Koska siirsimme ne jo aiemmin DOMContentLoaded-lohkon ulkopuolelle, niiden pitäisi olla globaalisti saatavilla. Tämän kaltaiset sitkeät virheet johtuvat lähes poikkeuksetta selaimen välimuistista tai siitä, ettei tiedosto ole tallentunut/latautunut oikein palvelimelle/GitHubiin.

Nollaa-napin toimiminen on hyvä merkki – se vahvistaa, että JavaScript-tiedosto ylipäätään latautuu ja DOMContentLoaded-koodi ajetaan (koska Nollaa-napin kuuntelija liitetään siellä addEventListener-metodilla). Mutta onclick/onchange-attribuutit eivät siis edelleenkään löydä funktioita globaalisti.

Kokeillaan uudelleen korjattua koodia ja keskitytään välimuistin tyhjentämiseen tarkemmin.

Tässä on sama, korjattu koodi uudelleen. Kopioi tämä kokonaisuudessaan ja korvaa sillä koko tilastokuvat_versio2.html-tiedostosi sisältö. Tallenna tiedosto huolellisesti.
HTML

<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Kätkö tilastojen - Kuvageneraattori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      /* Määritellään värejä CSS-muuttujiin, helpottaa ylläpitoa */
      --bg-color-dark: #1e1e2e; /* Syvempi tumma tausta */
      --text-color-light: #cdd6f4; /* Pehmeämpi vaalea teksti */
      --card-bg: #313244; /* Elementtien tausta */
      --border-color: #45475a; /* Reunusten väri */
      --accent-color: #89b4fa; /* Korostusväri linkeille/napeille (valinnainen) */
      --button-bg: #585b70; /* Nappien tausta */
      --button-hover-bg: #6c7086; /* Nappien hover-tausta */
      --border-radius: 8px; /* Yleinen kulmien pyöristys */
      --spacing-small: 0.5em;
      --spacing-medium: 1em;
      --spacing-large: 1.5em;

      /* Uusia, pienempiä väljyyksiä mobiilille */
      --spacing-mobile-small: 0.3em;
      --spacing-mobile-medium: 0.8em;
      --spacing-mobile-large: 1em;
    }

    body {
      background-color: var(--bg-color-dark);
      color: var(--text-color-light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Hiukan modernimpi fontti */
      margin: var(--spacing-medium);
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: var(--spacing-large) auto; /* Keskitetty ja ylä/alareunaan tilaa */
      padding: var(--spacing-large);
      background-color: var(--card-bg); /* Containerille oma tausta */
      border-radius: var(--border-radius);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Kevyt varjo */
    }

    /* Uusi tyyli otsikkoalueelle, jossa logo ja teksti ovat rinnakkain */
    .header-area {
        display: flex; /* Käytetään flexboxia */
        align-items: center; /* Keskitetään elementit pystysuunnassa */
        margin-bottom: var(--spacing-large); /* Lisätään reilusti tilaa otsikkoalueen alle */
        padding-bottom: var(--spacing-medium); /* Pieni sisäinen alareuna */
        border-bottom: 1px solid var(--border-color); /* Kevyt erotinviiva */
    }

    /* Tyyli logokuvalle otsikkoalueella */
    .header-area .logo {
        width: 70px; /* Suurempi koko logolle */
        height: 70px; /* Neliö */
        margin-right: var(--spacing-medium); /* Lisää tilaa logon ja tekstin väliin */
        border: none; /* Poista mahdollinen kuvan reunus */
        flex-shrink: 0; /* Estää logoa kutistumasta liikaa pienellä näytöllä */
        border-radius: var(--border-radius); /* Pyöristetään myös logon kulmia */
    }

    /* Tyyli otsikkotekstille otsikkoalueella */
    .header-area h2 {
        margin: 0; /* Poistaa h2:n oletusmarginaalit */
        font-size: 1.8em; /* Hieman suurempi otsikko */
        color: var(--text-color-light); /* Varmistetaan tekstin väri */
    }

    label {
      display: inline-block;
      margin-bottom: var(--spacing-small);
      margin-top: var(--spacing-medium);
      font-weight: bold; /* Labelit lihavoituina */
    }

    select, input[type="date"], input[type="text"] {
      width: calc(100% - 1em); /* Leveys 100% miinus padding, jotta pysyy containerissa */
      padding: var(--spacing-small);
      margin-bottom: var(--spacing-medium);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius); /* Pyöreämmät kulmat */
      background-color: var(--bg-color-dark); /* Sama tausta kuin bodyllä tai hieman tummempi */
      color: var(--text-color-light);
      font-size: 1em;
      box-sizing: border-box; /* Sisällytä padding ja border leveyteen */
    }

    /* Lomake-elementtien focus-tila */
     select:focus, input[type="date"]:focus, input[type="text"]:focus {
        outline: none; /* Poista oletus focus-reunus */
        border-color: var(--accent-color); /* Korosta reunus focus-värillä */
        box-shadow: 0 0 5px var(--accent-color); /* Lisää kevyt varjo */
     }


    .row {
      display: flex;
      gap: var(--spacing-small); /* Pienempi rako elementtien välissä */
      flex-wrap: wrap;
      width: 100%;
      margin-bottom: var(--spacing-medium); /* Lisää tilaa rivin alle */
    }

    .row > div {
      flex: 1;
      min-width: 100px; /* Minimileveys riveillä (desktop) */
    }

    button {
      margin-top: var(--spacing-medium);
      padding: var(--spacing-small) var(--spacing-medium);
      background-color: var(--button-bg);
      color: var(--text-color-light);
      border: none;
      border-radius: var(--border-radius); /* Pyöreämmät kulmat */
      cursor: pointer;
      font-size: 1.1em; /* Hieman suurempi teksti napissa */
      transition: background-color 0.3s ease; /* Animaatio hoveriin */
    }

    button:hover {
      background-color: var(--button-hover-bg);
    }

    a {
      color: var(--accent-color); /* Linkkien väri */
      display: inline-block;
      margin-top: var(--spacing-medium);
      text-decoration: none; /* Poista alleviivaus */
      transition: color 0.3s ease;
    }

    a:hover {
        color: #a6e3a1; /* Hieman eri sävy hoverissa */
        text-decoration: underline; /* Lisää alleviivaus hoverissa */
    }

    /* --- Säännöt kuvan ja overlayn wrapperille sekä overlaylle --- */
    .image-wrapper {
        position: relative; /* Mahdollistaa suhteellisen sisällön */
        display: block; /* Varmistaa, että vie tilaa */
        margin-top: var(--spacing-medium); /* Tilaa wrapperin yläpuolelle */
        max-width: 100%; /* Varmistaa, ettei wrapper mene yli containerin leveyden */
        /* Piilotetaan oletuksena tai jos kuvaa ei ole */
        display: none;
        text-align: center; /* Keskitetään sekä teksti että kuva wrapperin sisällä */
    }

    .image-wrapper #kuva { /* Tyyli kuvalle wrapperin sisällä */
        display: block; /* Kuva omalle rivilleen */
        max-width: 100%; /* Kuva täyttää wrapperin leveyden */
        height: auto; /* Säilyttää kuvasuhteen */
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        cursor: default; /* Oletuskursori, JS muuttaa tarvittaessa */
        margin: 0 auto; /* Keskitä kuva wrapperin sisällä */
    }

    #map-overlay { /* Tyyli tekstille kuvan YLÄPUOLELLA */
        display: block; /* Varmistaa, että vie tilaa */
        text-align: center; /* Keskitetään vaakasuunnassa */
        color: var(--text-color-light); /* Tekstin väri */
        font-size: 0.9em; /* Pienempi fonttikoko */
        margin-bottom: var(--spacing-small); /* Tilaa tekstin ja kuvan väliin */
        display: none; /* Piilotettu oletuksena */
    }
    /* --- Säännöt päättyvät --- */


    /* Tyyli linkille ladatun kuvan alla */
    a#linkki { /* Kohdennetaan tarkemmin linkkiin kuvan alla */
        margin-top: var(--spacing-medium);
        /* Piilotetaan oletuksena tai jos kuva itse on linkki */
         display: none;
         /* Muita linkkityylejä */
    }

    /* Tyyli kopiointinapille */
    #copyLinkButton {
        margin-top: var(--spacing-small); /* Ylämarginaali erottamaan linkistä/kuvasta */
        padding: 0.4em 0.8em; /* Pienempi padding kuin päänapissa */
        font-size: 0.9em; /* Pienempi fonttikoko */
        display: none; /* Piilotettu oletuksena */
        /* Perii muita nappityylejä (tausta, väri, reunat, kursori jne.) */
    }

    /* --- Vuosikalenterin lisäsuodattimille --- */
    #yearSpecificFilters {
        display: none; /* Piilotettu oletuksena, JS näyttää kun valitaan vuosikalenteri */
        margin-top: var(--spacing-medium);
        padding-top: var(--spacing-medium);
        border-top: 1px solid var(--border-color); /* Erotinviiva */
    }

     /* Tyyli inputille kun se on disabloitu */
    #locationFilterValue:disabled {
        background-color: #2a2a3a; /* Hieman eri tausta */
        cursor: not-allowed;
        color: #888; /* Harmaampi teksti */
    }
     /* Paikkamerkkitekstin väri tummassa tilassa */
    input::placeholder {
      color: #a0a0a0;
      opacity: 1;
    }

    /* --- Tyyli käyttäjänimikentän ja Nollaa-napin wrapperille --- */
    .user-input-container {
        display: flex;
        align-items: flex-end; /* Kohdista nappi syöttökentän alareunaan */
        gap: var(--spacing-small); /* Rako syöttökentän ja napin väliin */
         margin-bottom: var(--spacing-medium); /* Vastaa syöttökentän normaalia alareunamarginaalia */
    }

    /* Säädä syöttökentän leveyttä flex-containerin sisällä */
    .user-input-container input[type="text"] {
         flex-grow: 1; /* Anna syöttökentälle tilaa kasvaa */
         width: auto; /* Kumoa calc(100%-1em), flex hoitaa leveyden */
          margin-bottom: 0; /* Poista syöttökentän oma alareunamarginaali flexissä */
    }

     /* Säädä Nollaa-napin ulkoasua */
    #resetButton {
        /* Perii pääosan nappityyleistä */
        padding: var(--spacing-small); /* Pienempi padding */
         font-size: 1em; /* Sama fonttikoko kuin syöttökentässä */
         /* Yritä sovittaa napin korkeus syöttökentän korkeuteen */
         height: calc(1em + 2 * var(--spacing-small) + 2 * 1px); /* font-size + 2*padding-top/bottom + 2*border-width */
         margin-top: 0; /* Poista oletus ylämarginaali */
    }

    /* --- Tyyli sijaintikentän ja infokuvakkeen wrapperille --- */
    /* Huom: Tässä containerissa on nyt input-kenttä ja maakunta-ikoni. Paikkakunnan valitsimet ovat omassa divissään alla. */
    .location-input-row {
        display: flex;
        align-items: center; /* Kohdista syöttökenttä ja kuvake pystysuunnassa */
        gap: var(--spacing-small); /* Rako elementtien väliin */
         margin-bottom: var(--spacing-small); /* Tilaa tämän rivin ja alla olevien apuvalikoiden/listan väliin */
    }

    /* Säädä syöttökentän leveyttä wrapperin sisällä */
    .location-input-row input[type="text"] {
        flex-grow: 1; /* Anna syöttökentälle tilaa kasvaa */
         width: auto; /* Anna flexin hallita leveyttä */
         margin-bottom: 0; /* Poista alareunamarginaali */
    }

    /* Tyyli info-kuvakkeelle (Maakunta) */
    .info-icon {
        cursor: pointer;
        color: var(--accent-color); /* Korostusväri */
        font-weight: bold;
        flex-shrink: 0; /* Estä kuvaketta kutistumasta */
        display: none; /* Piilotettu oletuksena, JS näyttää kun tarpeen (vain maakunnalle) */
    }

     /* --- UUSI: Tyyli paikkakunta-valinnan apuvalikoiden containerille --- */
    #municipalitySelectAids {
        /* Piilotettu oletuksena, JS näyttää kun Paikkakunta valitaan */
        display: none; /* Default tila CSS:ssä */
        /* Käytetään flexboxia valikoiden ja napin sijoitteluun riville */
        /* display: flex;  -- tämä siirretään JS:ään kun näytetään */
        flex-wrap: wrap; /* Salli rivitys pienellä näytöllä */
        gap: var(--spacing-small); /* Rako elementtien välissä */
        align-items: flex-end; /* Kohdista napin alareuna valikoiden alareunaan */
        margin-bottom: var(--spacing-medium); /* Tilaa containerin alle */
    }

    #municipalitySelectAids label {
         margin-top: 0; /* Poista ylempi marginaali, flex hoitaa */
         margin-bottom: var(--spacing-mobile-small); /* Pienempi marginaali mobiilissa */
         flex-basis: 100%; /* Labelit omalle rivilleen pienellä näytöllä */
    }

    #municipalitySelectAids select {
        flex: 1; /* Anna valikoille tilaa kasvaa ja jakaa tila */
        min-width: 120px; /* Minimileveys valikoille */
         margin-bottom: 0; /* Poista alareunamarginaali */
         width: auto; /* Anna flexin hoitaa leveyttä */
    }

     #municipalitySelectAids button {
         flex-grow: 0; /* Älä anna napin kasvaa liikaa */
         flex-shrink: 0; /* Älä anna napin kutistua liikaa */
         margin-top: 0; /* Poista oletus ylämarginaali */
          /* Yritä sovittaa korkeus input/select -kenttiin */
         padding: var(--spacing-small);
         font-size: 1em;
         height: calc(1em + 2 * var(--spacing-small) + 2 * 1px);
         /* Disabloidun napin tyyli JS:ään */
     }


    /* Tyyli maakuntalistan containerille (käytetään edelleen Maakunnalle) */
    #regionListContainer {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-small);
        margin-top: var(--spacing-small);
        max-height: 150px; /* Rajoita korkeutta */
        overflow-y: auto; /* Lisää vierityspalkki tarvittaessa */
        background-color: var(--card-bg); /* Sama tausta kuin containerilla */
        z-index: 1; /* Varmista, että näkyy muiden päällä tarvittaessa */
        position: relative; /* Varmista position, jotta z-index toimii */
        font-size: 0.9em; /* Pienempi teksti */
    }

    /* Tyyli maakuntalistan yksittäisille kohteille */
    .region-list-item {
        padding: var(--spacing-mobile-small); /* Pienempi padding */
        cursor: pointer;
    }
    /* Optional: hover effect for list items */
    .region-list-item:hover {
        background-color: var(--button-hover-bg); /* Hover-väri */
    }


    /* Mobiililaitteille (< 600px) */
    @media (max-width: 600px) {
        body { margin: var(--spacing-mobile-medium); }
        .container {
            padding: var(--spacing-mobile-large);
            margin: var(--spacing-mobile-large) auto;
        }
        .header-area {
            flex-direction: column; align-items: flex-start;
             margin-bottom: var(--spacing-mobile-large);
        }
        .header-area .logo {
            margin-right: 0; margin-bottom: var(--spacing-mobile-medium);
            width: 60px; height: 60px;
        }
        .header-area h2 { font-size: 1.5em; }
        label { margin-top: var(--spacing-mobile-medium); margin-bottom: var(--spacing-mobile-small); }
        select, input[type="date"], input[type="text"] { margin-bottom: var(--spacing-mobile-medium); padding: var(--spacing-mobile-small); }

        /* Mobiili säännöt Aikarajauksen riveille */
        #aikaKentat > .row {
             flex-direction: row; flex-wrap: wrap;
             gap: var(--spacing-mobile-small);
             margin-bottom: var(--spacing-mobile-small);
        }
        #aikaKentat > .row > div {
            min-width: 0; flex: 1 1 calc(50% - var(--spacing-mobile-small) / 2);
        }

         /* Yleiset mobiili säännöt muille .row elementeille */
         .row:not(#aikaKentat > .row) {
             flex-direction: column;
             gap: var(--spacing-mobile-medium);
             margin-bottom: var(--spacing-mobile-medium);
         }
         .row:not(#aikaKentat > .row) > div { min-width: 100%; }

        /* Mobiilisäädöt käyttäjänimikentälle ja Nollaa-napille */
        .user-input-container {
            flex-direction: column; align-items: stretch;
            gap: var(--spacing-mobile-small); margin-bottom: var(--spacing-mobile-medium);
        }
        .user-input-container input[type="text"], #resetButton {
             width: 100%; height: auto; flex-grow: 0;
        }
         #resetButton { padding: var(--spacing-mobile-small); }

        /* Mobiilisäädöt sijaintikentän ja infokuvakkeen wrapperille */
         .location-input-row { /* input and region icon */
             flex-direction: row; /* Pidä rinnakkain */
             align-items: center;
             gap: var(--spacing-mobile-small);
             margin-bottom: var(--spacing-mobile-small); /* Tilaa apuvalikoihin */
         }
          .location-input-row input[type="text"] { width: auto; flex-grow: 1; }
          .info-icon { align-self: center; margin-bottom: 0; width: auto; }

        /* Mobiilisäädöt paikkakunta-valinnan apuvalikoille */
         #municipalitySelectAids {
             flex-direction: column; /* Pino päällekkäin mobiilissa */
             align-items: stretch;
             gap: var(--spacing-mobile-small);
             margin-bottom: var(--spacing-mobile-medium);
         }
          #municipalitySelectAids label {
             flex-basis: auto; /* Kumoa 100% mobile-kohtainen asetus tässä flex containerissa */
             width: 100%; /* Vie koko leveys */
             margin-bottom: var(--spacing-mobile-small);
          }
          #municipalitySelectAids select {
              flex: none; /* Kumoa flex: 1 */
              width: 100%; /* Vie koko leveys */
              min-width: 0; /* Kumoa minimileveys */
          }
           #municipalitySelectAids button {
              width: 100%; /* Nappi koko leveydelle */
              padding: var(--spacing-mobile-small);
              height: auto;
           }


          #regionListContainer {
              max-height: 100px; padding: var(--spacing-mobile-small);
              margin-top: var(--spacing-mobile-small);
         }


        button { margin-top: var(--spacing-mobile-medium); padding: var(--spacing-mobile-small) var(--spacing-mobile-medium); width: 100%; }
        a#linkki { margin-top: var(--spacing-mobile-medium); }
        #map-overlay { font-size: 0.8em; margin-bottom: var(--spacing-mobile-small); }
        #copyLinkButton { margin-top: var(--spacing-mobile-small); width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-area">
        <img src="mikkokalevi.png" alt="Sivuston logo" class="logo">
        <h2>Kätkö tilastojen - Kuvageneraattori</h2>
    </div>

    <label for="user">Käyttäjätunnus:</label>
    <div class="user-input-container">
        <input type="text" id="user" list="userlist" placeholder="esim. mikkokalevi">
        <datalist id="userlist">
          <option value="mikkokalevi">
          <option value="Tiltu">
          <option value="lahjemies">
          <option value="eukka">
          <option value="milde04">
        </datalist>
         <button id="resetButton" type="button">Nollaa</button>
    </div>


    <label for="kuvatyyppi">Kuvan tyyppi:</label>
    <select id="kuvatyyppi" onchange="handleKuvatyyppiChange()">
      <option value="matrix">T/D-taulukko</option>
      <option value="kunta">Kuntakartta</option>
      <option value="year">Vuosikalenteri</option>
      <option value="ftfkunta">FTF kuntakartta</option>
      <option value="hiddenday">Jasmer</option>
      <option value="saari">saarilöydöt</option>
    </select>

    <label for="aikavalinta">Aikarajaus:</label>
    <select id="aikavalinta" onchange="toggleAikaKentat()">
      <option value="ei">Ei aikarajausta</option>
      <option value="kylla">Valitse aikaväli</option>
    </select>

    <div id="aikaKentat" style="display:none;">
      <div class="row">
        <div>
          <label for="year">Vuosi:</label>
          <select id="year">
            <option value="current">—</option>
          </select>
        </div>
        <div>
          <label for="month">Kuukausi:</label>
          <select id="month">
            <option value="current">—</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="startdate">Alkupäivä:</label>
          <input type="date" id="startdate">
        </div>
        <div>
          <label for="enddate">Loppupäivä:</label>
          <input type="date" id="enddate">
        </div>
      </div>
    </div>

    <label for="cachetype">Kätkötyyppi:</label>
    <select id="cachetype">
      <option value="">—</option>
      <option value="1">Traditional Cache</option>
      <option value="2">Multi-cache</option>
      <option value="3">Unknown Cache</option>
      <option value="4">Letterbox Hybrid</option>
      <option value="5">Event Cache</option>
      <option value="6">Earthcache</option>
      <option value="7">Virtual Cache</option>
      <option value="8">Webcam Cache</option>
      <option value="9">Wherigo Cache</option>
      <option value="10">Community Celebration Event</option>
      <option value="11">Mega-Event Cache</option>
      <option value="12">Cache In Trash Out Event</option>
      <option value="13">Giga-Event Cache</option>
      <option value="14">Groundspeak Block Party</option>
      <option value="98">Muut paitsi tradit</option>
      <option value="99">Kaikki event-tyypit</option>
      </select>

    <div id="yearSpecificFilters">
        <label>Vuosikalenterin lisäsuodatus:</label>
        <div class="row">
            <div>
                <label for="pkuntaMkuntaChoice">Sijainnin tyyppi:</label>
                <select id="pkuntaMkuntaChoice" onchange="handlePkuntaMkuntaChoice()">
                    <option value="none">Ei rajoitusta</option>
                    <option value="pkunta">Paikkakunta</option>
                    <option value="mkunta">Maakunta</option>
                </select>
            </div>
            <div>
                 <label for="locationFilterValue">Nimi (pilkulla eroteltuna):</label>
                 <div class="location-input-row">
                     <input type="text" id="locationFilterValue" disabled placeholder="">
                     <span id="regionInfoIcon" class="info-icon" title="Näytä maakunnat">ⓘ</span>
                 </div>

                 <div id="regionListContainer" style="display: none;">
                     </div>

                 <div id="municipalitySelectAids" style="display: none;">
                     <label for="municipalityRegionSelect">Maakunta:</label>
                     <select id="municipalityRegionSelect">
                         <option value="">— Valitse maakunta —</option>
                         </select>

                     <label for="municipalitySelect">Kunta:</label>
                     <select id="municipalitySelect" disabled>
                          <option value="">— Valitse kunta —</option>
                         </select>

                      <button id="addMunicipalityButton" type="button">Lisää kunta</button>
                 </div>

            </div>
        </div>
         <div class="row">
             <div>
                  <label for="extraFilter">Lisäsuodatus:</label>
                  <select id="extraFilter">
                      <option value="">—</option>
                      <option value="1">Vain FTF-löydöt</option>
                      <option value="2">Vain haastekätköt</option>
                      <option value="3">Vain haastekätköjen FTF-löydöt</option>
                  </select>
             </div>
              <div></div>
         </div>
    </div>
    <button onclick="luoLinkki()">Luo linkki ja kuva</button>

    <div class="image-wrapper">
      <div id="map-overlay">Klikkaa karttaa isommaksi</div>
      <img id="kuva" alt="">
    </div>

    <a id="linkki" href="#" target="_blank"></a>

    <button id="copyLinkButton" type="button">Kopioi linkki</button>


  </div>

  <script>
    // Konsolilog, joka varmistaa, että tämä skriptilohko ylipäätään ajetaan
    console.log("Script block started. Functions should be defined globally below.");

    // Copyright (c) 2025 mikkokalevi

    // Mappaus käyttäjien nimimerkkien ja userid:den välillä
    const userIds = {
        "mikkokalevi": 306478,
        "eukka": 36206,
        "Tiltu": 309395,
        "lahjemies": 308779,
        "milde04": 29523
    };

    const tripletOptionData = { value: '90', text: 'Triplet-extra: tradi, multi, mysse löydöt' };

    // Lista Suomen maakunnista (käytetään maakunta-valintaan)
    const suomenMaakunnat = [
        "Ahvenanmaa", "Etelä-Karjala", "Etelä-Pohjanmaa", "Etelä-Savo",
        "Kainuu", "Kanta-Häme", "Keski-Pohjanmaa", "Keski-Suomi",
        "Kymenlaakso", "Lappi", "Pirkanmaa", "Pohjanmaa",
        "Pohjois-Karjala", "Pohjois-Pohjanmaa", "Pohjois-Savo", "Päijät-Häme",
        "Satakunta", "Uusimaa", "Varsinais-Suomi"
    ].sort();

    // Maakunta -> Kunta -mapping paikkakunta-valinnan apuvalikoita varten
    const maakuntaKuntaMap = {
        "Ahvenanmaa": ["Brändö", "Eckerö", "Finström", "Föglö", "Geta", "Hammarland", "Jomala", "Kökar", "Kumlinge", "Lemland", "Lumparland", "Maarianhamina", "Saltvik", "Sottunga", "Sund", "Vårdö"],
        "Etelä-Karjala": ["Imatra", "Lappeenranta", "Lemi", "Luumäki", "Parikkala", "Rautjärvi", "Ruokolahti", "Savitaipale", "Taipalsaari"],
        "Etelä-Pohjanmaa": ["Alajärvi", "Ilmajoki", "Isojoki", "Isokyrö", "Karijoki", "Kauhajoki", "Kauhava", "Kurikka", "Lappajärvi", "Lapua", "Seinäjoki", "Soini", "Teuva", "Vimpeli", "Ähtäri"],
        "Etelä-Savo": ["Enonkoski", "Hirvensalmi", "Juva", "Kangasniemi", "Mikkeli", "Mäntyharju", "Pertunmaa", "Pieksämäki", "Puumala", "Rantasalmi", "Savonlinna", "Sulkava"],
        "Kainuu": ["Hyrynsalmi", "Kajaani", "Kuhmo", "Paltamo", "Puolanka", "Ristijärvi", "Sotkamo", "Suomussalmi", "Vaala"],
        "Kanta-Häme": ["Forssa", "Hattula", "Hausjärvi", "Humppila", "Hämeenlinna", "Janakkala", "Jokioinen", "Lopii", "Riihimäki", "Tammela", "Ypäjä"],
        "Keski-Pohjanmaa": ["Halsua", "Kannus", "Kaustinen", "Kokkola", "Lestijärvi", "Perho", "Toholampi", "Veteli"],
        "Keski-Suomi": ["Hankasalmi", "Joutsa", "Jyväskylä", "Jämsä", "Kannonkoski", "Karstula", "Keuruu", "Kinnula", "Konnevesi", "Kuhmoinen", "Kyyjärvi", "Laukaa", "Luhanka", "Multia", "Muurame", "Petäjävesi", "Pihtipudas", "Saarijärvi", "Toivakka", "Uurainen", "Viitasaari", "Äänekoski"],
        "Kymenlaakso": ["Hamina", "Kotka", "Kouvola", "Miehikkälä", "Pyhtää", "Virolahti"],
        "Lappi": ["Enontekiö", "Inari", "Kemi", "Kemijärvi", "Keminmaa", "Kittilä", "Kolari", "Muonio", "Pelkosenniemi", "Pello", "Posio", "Ranua", "Rovaniemi", "Salla", "Savukoski", "Simo", "Sodankylä", "Tervola", "Tornio", "Utsjoki", "Ylitornio"],
        "Pirkanmaa": ["Akaa", "Hämeenkyrö", "Ikaalinen", "Juupajoki", "Kangasala", "Kihniö", "Lempäälä", "Mänttä-Vilppula", "Nokia", "Orivesi", "Parkano", "Pirkkala", "Punkalaidun", "Pälkäne", "Ruovesi", "Sastamala", "Tampere", "Urjala", "Valkeakoski", "Vesilahti", "Virrat", "Ylöjärvi"],
        "Pohjanmaa": ["Jakobstad", "Kaskinen", "Korsnäs", "Kristinestad", "Kruunupyy", "Laihia", "Larsmo", "Maalahti", "Närpiö", "Pedersören kunta", "Vaasa", "Vörå"],
        "Pohjois-Karjala": ["Heinävesi", "Ilomantsi", "Joensuu", "Juuka", "Kontiolahti", "Lieksa", "Liperi", "Nurmes", "Outokumpu", "Polvijärvi", "Rääkkylä", "Siilinjärvi", "Valtimo"],
        "Pohjois-Pohjanmaa": ["Alavieska", "Haapajärvi", "Haapavesi", "Hailuoto", "Ii", "Kalajoki", "Kempele", "Kuusamo", "Kärsämäki", "Liminka", "Lumijoki", "Merijärvi", "Merikarvia", "Muhos", "Nivala", "Oulainen", "Oulu", "Pudasjärvi", "Pyhäjoki", "Pyhäjärvi", "Pyhäntä", "Raahe", "Reisjärvi", "Sievi", "Siikajoki", "Taivalkoski", "Tyrnävä", "Utajärvi", "Ylivieska"],
        "Pohjois-Savo": ["Iisalmi", "Kaavi", "Keitele", "Kiuruvesi", "Kuopio", "Lapinlahti", "Leppävirta", "Pielavesi", "Rautalampi", "Rautavaara", "Siilinjärvi", "Sonkajärvi", "Suonenjoki", "Tervo", "Tuusniemi", "Varkaus", "Vesanto", "Vieremä"],
        "Päijät-Häme": ["Asikkala", "Hartola", "Heinola", "Hollola", "Iitti", "Kärkölä", "Lahti", "Orimattila", "Padasjoki", "Sysmä"],
        "Satakunta": ["Eura", "Eurajoki", "Harjavalta", "Huittinen", "Jämijärvi", "Kankaanpää", "Karvia", "Kokemäki", "Merikarvia", "Nakkila", "Noormarkku", "Pomarkku", "Pori", "Rauma", "Siikainen", "Säkylä", "Ulvila"],
        "Uusimaa": ["Askola", "Espoo", "Hanko", "Helsinki", "Hyvinkää", "Inkoo", "Järvenpää", "Kirkkonummi", "Lapinjärvi", "Lohja", "Loviisa", "Mäntsälä", "Myrskylä", "Nurmijärvi", "Porvoo", "Pornainen", "Pukkila", "Raasepori", "Sipoo", "Siuntio", "Tuusula", "Vantaa", "Vihti"],
        "Varsinais-Suomi": ["Aura", "Kaarina", "Koski Tl", "Kustavi", "Laitila", "Lieto", "Loimaa", "Marttila", "Masku", "Mynämäki", "Naantali", "Nousiainen", "Oripää", "Paimio", "Pyhäranta", "Pöytyä", "Raisio", "Rusko", "Salo", "Sauvo", "Somero", "Taivassalo", "Turku", "Uusikaupunki", "Vehmaa"]
    };


    function formatDate(input) {
      const parts = input.split("-");
      if (!parts || parts.length !== 3) {
          console.error("Invalid date format for formatDate:", input);
          return "";
      }
      // KORJAUS: parts[1.] -> parts[1]
      return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }

    function toggleAikaKentat() {
      const valinta = document.getElementById("aikavalinta")?.value || '';
      const aikaKentatDiv = document.getElementById("aikaKentat");
       if (aikaKentatDiv) {
         aikaKentatDiv.style.display = valinta === "kylla" ? "block" : "none";
         console.log("Aikarajauskentät näkyvissä:", valinta === "kylla"); // Debugging
       } else {
         console.error("Element #aikaKentat not found in toggleAikaKentat.");
       }
        // Varmista Local Storage -tallennus
       saveSettingsToLocalStorage();
    }

    // Funktio näyttämään/piilottamaan vuosikalenterin lisäsuodattimet
    function toggleYearSpecificFilters() {
        const kuvatyyppiSelect = document.getElementById("kuvatyyppi");
        const yearSpecificFiltersDiv = document.getElementById("yearSpecificFilters");
        // Haetaan tarvittavat elementit tässä
        const pkuntaMkuntaChoiceSelect = document.getElementById("pkuntaMkuntaChoice");
        const municipalitySelectAids = document.getElementById("municipalitySelectAids"); // Haetaan apuvalikot
        const regionInfoIcon = document.getElementById("regionInfoIcon");
        const regionListContainer = document.getElementById("regionListContainer");


        if (!kuvatyyppiSelect || !yearSpecificFiltersDiv || !pkuntaMkuntaChoiceSelect || !municipalitySelectAids || !regionInfoIcon || !regionListContainer) {
             console.error("Required core year specific filter elements not found in toggleYearSpecificFilters.");
             return;
        }

        if (kuvatyyppiSelect.value === 'year') {
            yearSpecificFiltersDiv.style.display = 'block';
            console.log("Vuosikalenterin lisäsuodattimet näkyvissä."); // Debugging
            // Päivitä sijaintikentän tila ja apuelementtien näkyvyys
             handlePkuntaMkuntaChoice(); // Tämä kutsuu saveSettingsToLocalStorage:a lopussa
        } else {
            yearSpecificFiltersDiv.style.display = 'none';
             console.log("Vuosikalenterin lisäsuodattimet piilossa."); // Debugging
            // Nollaa arvot ja piilota elementit kun osio piilotetaan
            const locationFilterValueInput = document.getElementById("locationFilterValue");
             if(locationFilterValueInput) {
                 locationFilterValueInput.value = '';
                 locationFilterValueInput.disabled = true;
                 locationFilterValueInput.placeholder = "";
             }
            const extraFilterSelect = document.getElementById("extraFilter");
             if(extraFilterSelect) extraFilterSelect.value = '';

            // Nollataan pkuntaMkuntaChoiceSelect arvo tässä, koska koko osio piilotetaan
            // Tämän pitäisi käynnistää handlePkuntaMkuntaChoice, mutta varmistetaan kutsu
            pkuntaMkuntaChoiceSelect.value = 'none'; // Tämä laukaisee onchange -> handlePkuntaMkuntaChoice

            // Koska pkuntaMkuntaChoiceSelect.value on 'none', handlePkuntaMkuntaChoice() piilottaa iconit/apuvalikot
            // ja nollaa paikkakunta-apuvalikoiden tilan.
            // saveSettingsToLocalStorage() tallentaa tämän tilan lopussa.

        }
         // Varmista Local Storage -tallennus kuvatyypin vaihtuessa
        // saveSettingsToLocalStorage(); // Kutsutaan jo handlePkuntaMkuntaChoice:sta tai nollauksesta

    }

    // Funktio käsittelemään paikkakunta/maakunta -valinnan yksinoikeutta ja apuelementtien näyttämistä
    function handlePkuntaMkuntaChoice() {
        const pkuntaMkuntaChoiceSelect = document.getElementById("pkuntaMkuntaChoice");
        const locationFilterValueInput = document.getElementById("locationFilterValue");
        const regionInfoIcon = document.getElementById("regionInfoIcon"); // Maakunta icon
        const municipalitySelectAids = document.getElementById("municipalitySelectAids"); // Paikkakunta apuvalikot container
        const regionListContainer = document.getElementById("regionListContainer"); // Maakunta lista container

        // Hae paikkakunta-apuvalikoiden elementit
        const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
        const municipalitySelect = document.getElementById("municipalitySelect");
        const addMunicipalityButton = document.getElementById("addMunicipalityButton");


         if (!pkuntaMkuntaChoiceSelect || !locationFilterValueInput || !regionInfoIcon || !municipalitySelectAids || !regionListContainer || !municipalityRegionSelect || !municipalitySelect || !addMunicipalityButton) {
             console.error("Required pkunta/mkunta elements or aids not found in handler.");
             return;
         }

        const choice = pkuntaMkuntaChoiceSelect.value;
        console.log("Pkunta/Mkunta choice changed to:", choice); // Debugging

        // Piilota kaikki apuelementit aina aluksi
        regionInfoIcon.style.display = 'none';
        municipalitySelectAids.style.display = 'none'; // Piilota apuvalikot
        regionListContainer.style.display = 'none'; // Piilota maakuntalista container

        // Tyhjennä vanha maakuntalistan containerin sisältö (käytetään vain sille)
        regionListContainer.innerHTML = '';


        if (choice === 'pkunta') {
            locationFilterValueInput.disabled = false;
            locationFilterValueInput.placeholder = "esim. Lahti,Heinola"; // Paikkakunta placeholder (ei välilyöntiä)
            // Näytä Paikkakunta valinnan apuvalikot flexboxina
            municipalitySelectAids.style.display = 'flex';
            console.log("Municipality aids shown."); // Debugging


            // Varmista, että maakuntavalikko on populointu (tee vain kerran)
             if (municipalityRegionSelect.options.length <= 1) { // Tarkista onko vain default-option
                 console.log("Populating municipality region select...");
                 // Hae maakunnat maakuntaKuntaMap-objektin avaimista ja populoi valikko
                 Object.keys(maakuntaKuntaMap).sort().forEach(maakunta => {
                     const opt = document.createElement("option");
                     opt.value = maakunta;
                     opt.textContent = maakunta;
                     municipalityRegionSelect.appendChild(opt);
                 });
             }

             // Nollaa kuntavalikko ja disabloi se, kunnes maakunta on valittu uudelleen
             municipalitySelect.innerHTML = '<option value="">— Valitse kunta —</option>';
             municipalitySelect.disabled = true; // Disabloi oletuksena
             addMunicipalityButton.disabled = true; // Disabloi lisää-nappi
             // Asetetaan harmaampi väri disabloituna
             addMunicipalityButton.style.backgroundColor = '#888';
             addMunicipalityButton.style.cursor = 'not-allowed';


        } else if (choice === 'mkunta') {
             locationFilterValueInput.disabled = false;
             locationFilterValueInput.placeholder = "esim. Päijät-Häme,Uusimaa"; // Maakunta placeholder (ei välilyöntiä)
             // Näytä Maakunta Info -kuvake
             regionInfoIcon.style.display = 'inline-block';
             console.log("Region icon shown."); // Debugging
        }
         else { // choice === 'none'
            locationFilterValueInput.value = '';
            locationFilterValueInput.disabled = true;
            locationFilterValueInput.placeholder = "";
             console.log("Location filter reset and hidden."); // Debugging
        }
         // Tallenna asetusten tila Local Storageen aina, kun valinta muuttuu
         saveSettingsToLocalStorage(); // Kutsu yleistä tallennusta tässä
    }

    // Funktio populaamaan kuntavalikko maakuntavalinnan perusteella
    function populateMunicipalitySelect() {
         const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
         const municipalitySelect = document.getElementById("municipalitySelect");
         const addMunicipalityButton = document.getElementById("addMunicipalityButton"); // Hae nappi

         if (!municipalityRegionSelect || !municipalitySelect || !addMunicipalityButton) {
             console.error("Required municipality select elements or add button not found for population.");
             return;
         }

         const selectedRegion = municipalityRegionSelect.value;
         console.log("Populating municipalities for region:", selectedRegion); // Debugging

         // Tyhjennä kuntavalikko (pidä default-option)
         municipalitySelect.innerHTML = '<option value="">— Valitse kunta —</option>';
         municipalitySelect.disabled = true; // Disabloi oletuksena
         addMunicipalityButton.disabled = true; // Disabloi lisää-nappi
         addMunicipalityButton.style.backgroundColor = '#888'; // Harmaampi väri disabloituna
         addMunicipalityButton.style.cursor = 'not-allowed';

         if (selectedRegion && maakuntaKuntaMap[selectedRegion]) {
             const kunnat = maakuntaKuntaMap[selectedRegion].sort(); // Lajittele kunnat aakkosjärjestykseen
             kunnat.forEach(kunta => {
                 const opt = document.createElement("option");
                 opt.value = kunta;
                 opt.textContent = kunta;
                 municipalitySelect.appendChild(opt);
             });
             municipalitySelect.disabled = false; // Aktivoi kuntavalikko
              console.log(`Populated ${kunnat.length} municipalities.`); // Debugging

             // Huom: Lisää-nappi aktivoituu vasta kun kunta on valittu handleMunicipalitySelectChange:ssa
         }
         // Tallenna apuvalikoiden tila Local Storageen
         saveMunicipalitySelectState();
    }

    // Funktio käsittelemään "Lisää kunta" -napin klikkausta
    function addSelectedMunicipality() {
         const municipalitySelect = document.getElementById("municipalitySelect");
         const locationFilterValueInput = document.getElementById("locationFilterValue");

         if (!municipalitySelect || !locationFilterValueInput) {
             console.error("Required municipality select or location input not found for adding.");
             return;
         }

         const selectedMunicipality = municipalitySelect.value;
         console.log("Attempting to add municipality:", selectedMunicipality); // Debugging


         if (selectedMunicipality) { // Varmista, että jokin kunta on valittu (ei default-option)
             const currentValue = locationFilterValueInput.value.trim();
             if (currentValue) {
                 // Lisää pilkku ilman välilyöntiä pyydetyn muodon mukaisesti
                 locationFilterValueInput.value += ',' + selectedMunicipality;
             } else {
                 locationFilterValueInput.value = selectedMunicipality;
             }
             console.log("Location filter value updated to:", locationFilterValueInput.value); // Debugging

             // Vie fokus takaisin inputiin käytettävyyden parantamiseksi
             locationFilterValueInput.focus();

             // Optional: Nollaa kuntavalikko tai disabloi lisää-nappi valinnan jälkeen
             // municipalitySelect.value = ''; // Reset select to default
             // handleMunicipalitySelectChange(); // Kutsu tätä päivittämään napin tila, jos select nollataan

             // Tallenna päivitetty locationFilterValue Local Storageen heti
             saveSettingsToLocalStorage(); // Kutsu yleistä tallennusfunktiota

         } else {
              console.log("No municipality selected to add."); // Debugging
         }
    }

    // Kuuntelija kuntavalikon aktivoimiseksi ja "Lisää"-napin tilan päivittämiseksi
    function handleMunicipalitySelectChange() {
         const municipalitySelect = document.getElementById("municipalitySelect");
         const addMunicipalityButton = document.getElementById("addMunicipalityButton");

         if (!municipalitySelect || !addMunicipalityButton) {
             console.error("Required municipality select or add button not found for change handler.");
             return;
         }

         // Aktivoi "Lisää kunta" -nappi vain jos jokin kunta on valittuna (ei default-option)
         if (municipalitySelect.value) {
             addMunicipalityButton.disabled = false;
             addMunicipalityButton.style.backgroundColor = ''; // Palauta normaali väri
             addMunicipalityButton.style.cursor = 'pointer'; // Palauta kursori
             console.log("Add municipality button enabled."); // Debugging
         } else {
             addMunicipalityButton.disabled = true;
             addMunicipalityButton.style.backgroundColor = '#888'; // Harmaampi väri
             addMunicipalityButton.style.cursor = 'not-allowed';
             console.log("Add municipality button disabled."); // Debugging
         }
         // Tallenna apuvalikoiden tila Local Storageen
         saveMunicipalitySelectState(); // Tämä kutsuu saveSettingsToLocalStoragea sisäisesti
    }


    // Funktio populoi ja näyttää/piilottaa maakuntalistan (käytetään vain Maakunnalle)
    function toggleRegionList() {
         const regionListContainer = document.getElementById("regionListContainer");
         if (!regionListContainer) {
             console.error("Region list container not found for toggle.");
             return;
         }

         if (regionListContainer.style.display === 'block') {
             console.log("Hiding region list."); // Debugging
             regionListContainer.style.display = 'none';
         } else {
             if (regionListContainer.childElementCount === 0) {
                 console.log("Populating region list..."); // Debugging
                 suomenMaakunnat.forEach(maakunta => {
                     const regionItem = document.createElement('div');
                     regionItem.textContent = maakunta;
                     regionItem.classList.add('region-list-item');

                     regionItem.addEventListener('click', function() {
                          const locationInput = document.getElementById("locationFilterValue");
                          if (locationInput) {
                               const currentValue = locationInput.value.trim();
                               if (currentValue) {
                                   // Lisää pilkku ilman välilyöntiä pyydetyn muodon mukaisesti
                                   // Varmista, ettei tuplapilkkua tule
                                   if (!currentValue.endsWith(',')) {
                                       locationInput.value += ',';
                                   }
                               }
                               locationInput.value += this.textContent;
                               locationInput.focus();
                               toggleRegionList(); // Piilota lista valinnan jälkeen

                               // Tallenna päivitetty locationFilterValue Local Storageen heti
                               saveSettingsToLocalStorage(); // Kutsu yleistä tallennusfunktiota
                          }
                     });

                     regionListContainer.appendChild(regionItem);
                 });
                  console.log("Region list population complete."); // Debugging
             } else {
                 console.log("Region list already populated."); // Debugging
             }

             console.log("Showing region list."); // Debugging
             regionListContainer.style.display = 'block';
         }
         // Tallenna apuvalikoiden tila (joka piilotetaan) Local Storageen
         saveMunicipalitySelectState(); // Tämä kutsuu saveSettingsToLocalStoragea sisäisesti
    }

    // Yleinen funktio asetusten tallentamiseen Local Storageen
    // Tätä kutsutaan useista paikoista, kun jokin asetus muuttuu
    function saveSettingsToLocalStorage() {
         // Hae kaikki elementit arvojen saamiseksi
         const userElement = document.getElementById("user");
         const kuvatyyppiElement = document.getElementById("kuvatyyppi");
         const aikavalintaElement = document.getElementById("aikavalinta");
         const yearSelect = document.getElementById("year");
         const monthSelect = document.getElementById("month");
         const startdateElement = document.getElementById("startdate");
         const enddateElement = document.getElementById("enddate");
         const cachetypeElement = document.getElementById("cachetype");
         const pkuntaMkuntaChoiceElement = document.getElementById("pkuntaMkuntaChoice");
         const locationFilterValueElement = document.getElementById("locationFilterValue");
         const extraFilterElement = document.getElementById("extraFilter");
         // Huom: municipalitySelectAids elementtejä ei tarvitse hakea tässä, niiden arvot tallennetaan erikseen
         // saveMunicipalitySelectState:ssa, joka kutsutaan tästä

         const settingsToSave = {
             user: userElement?.value.trim() || '',
             kuvatyyppi: kuvatyyppiElement?.value || '',
             aikavalinta: aikavalintaElement?.value || '',
             year: yearSelect?.value || '',
             month: monthSelect?.value || '',
             startdate: startdateElement?.value || '',
             enddate: enddateElement?.value || '',
             cachetype: cachetypeElement?.value || '',
             pkuntaMkuntaChoice: pkuntaMkuntaChoiceElement?.value || '',
             locationFilterValue: locationFilterValueElement?.value.trim() || '',
             extraFilter: extraFilterElement?.value || ''
             // Maakunta/Kunta apuvalikoiden arvot lisätään tähän objektiin saveMunicipalitySelectState:ssa
         };

         // Yhdistä maakunta/kunta apuvalikoiden tallennettu tila pääasetuksiin, jos se on olemassa Local Storagessa
         // Tämä on välttämätöntä, koska saveMunicipalitySelectState muokkaa samaa Local Storage -avainta
         try {
             const existingSettingsString = localStorage.getItem('statGeneratorSettings');
             if (existingSettingsString) {
                  const existingSettings = JSON.parse(existingSettingsString);
                  if (existingSettings.municipalityRegionSelectValue !== undefined) {
                      settingsToSave.municipalityRegionSelectValue = existingSettings.municipalityRegionSelectValue;
                  }
                  if (existingSettings.municipalitySelectValue !== undefined) {
                      settingsToSave.municipalitySelectValue = existingSettings.municipalitySelectValue;
                  }
             }
         } catch (e) {
              console.error("Could not merge municipality select state from Local Storage:", e);
         }


         try {
             localStorage.setItem('statGeneratorSettings', JSON.stringify(settingsToSave));
             console.log("Settings saved to Local Storage."); // Debugging
         } catch (e) {
             console.error("Could not save settings to Local Storage", e);
         }
    }


    // Funktio asetusten tallentamiseen Local Storageen erityisesti paikkakunta-apuvalikoiden osalta
    // Tätä kutsutaan vain, kun sijainnin tyyppi vaihtuu tai apuvalikoiden arvo muuttuu
    function saveMunicipalitySelectState() {
         const pkuntaMkuntaChoiceElement = document.getElementById("pkuntaMkuntaChoice");
         const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
         const municipalitySelect = document.getElementById("municipalitySelect");

         if (!pkuntaMkuntaChoiceElement || !municipalityRegionSelect || !municipalitySelect) {
             console.error("Missing elements for saving municipality select state. Cannot save municipality select state.");
             // Kutsu yleistä tallennusta ilman apuvalikoiden tilaa (joka on jo tehty saveSettingsToLocalStorage:ssa)
             return; // Lopeta tässä, koska elementtejä puuttuu
         }

        // Lataa nykyiset asetukset, jotta ei ylikirjoiteta kaikkea
         try {
             const savedSettingsString = localStorage.getItem('statGeneratorSettings');
             let settingsToSave = savedSettingsString ? JSON.parse(savedSettingsString) : {};

            // Tallenna paikkakunta-apuvalikoiden tila vain jos Sijainnin tyyppi on Paikkakunta
             if (pkuntaMkuntaChoiceElement.value === 'pkunta') {
                 settingsToSave.municipalityRegionSelectValue = municipalityRegionSelect.value;
                 settingsToSave.municipalitySelectValue = municipalitySelect.value;
                  console.log("Saving municipality select state:", { region: municipalityRegionSelect.value, municipality: municipalitySelect.value }); // Debugging

             } else {
                 // Jos ei ole Paikkakunta-tilassa, poista mahdollisesti tallennetut apuvalikoiden arvot Local Storagesta
                 delete settingsToSave.municipalityRegionSelectValue;
                 delete settingsToSave.municipalitySelectValue;
                 console.log("Municipality select state cleared from Storage."); // Debugging
             }

             localStorage.setItem('statGeneratorSettings', JSON.stringify(settingsToSave));


         } catch (e) {
             console.error("Could not save municipality select state to Local Storage", e);
         }
         // Varmista, että yleiset asetukset tallentuvat myös, jos jotain muuta on muuttunut
         // Tätä kutsutaan jo handlePkuntaMkuntaChoice:sta ja handleMunicipalitySelectChange:sta,
         // mutta varmuuden vuoksi voisi kutsua myös tästä, joskin se saattaa olla redundanttia.
         // saveSettingsToLocalStorage(); // Ei kutsuta tästä, ettei synny tallennussilmukkaa
    }


    // Funktio asetusten lataamiseen Local Storagesta
    // Tätä kutsutaan vain kerran DOMContentLoadedissa
    function loadSettingsFromLocalStorage() {
         try {
             const savedSettings = localStorage.getItem('statGeneratorSettings');
             if (savedSettings) {
                 const settings = JSON.parse(savedSettings);
                 console.log("Loading settings:", settings); // Debugging

                 // Hae kaikki elementit ennen arvojen asettamista
                 const userElement = document.getElementById("user");
                 const kuvatyyppiElement = document.getElementById("kuvatyyppi");
                 const aikavalintaElement = document.getElementById("aikavalinta");
                 const yearSelect = document.getElementById("year");
                 const monthSelect = document.getElementById("month");
                 const startdateElement = document.getElementById("startdate");
                 const enddateElement = document.getElementById("enddate");
                 const cachetypeElement = document.getElementById("cachetype");
                 const pkuntaMkuntaChoiceElement = document.getElementById("pkuntaMkuntaChoice");
                 const locationFilterValueElement = document.getElementById("locationFilterValue");
                 const extraFilterElement = document.getElementById("extraFilter");
                 const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
                 const municipalitySelect = document.getElementById("municipalitySelect");


                 // Täytä peruskentät (tarkista elementin olemassaolo)
                 if (userElement && settings.user !== undefined) userElement.value = settings.user;
                 if (kuvatyyppiElement && settings.kuvatyyppi !== undefined) kuvatyyppiElement.value = settings.kuvatyyppi;
                 if (aikavalintaElement && settings.aikavalinta !== undefined) aikavalintaElement.value = settings.aikavalinta;
                 if (yearSelect && settings.year !== undefined) yearSelect.value = settings.year;
                 if (monthSelect && settings.month !== undefined) monthSelect.value = settings.month;
                 if (startdateElement && settings.startdate !== undefined) startdateElement.value = settings.startdate;
                 if (enddateElement && settings.enddate !== undefined) enddateElement.value = settings.enddate;
                 if (pkuntaMkuntaChoiceElement && settings.pkuntaMkuntaChoice !== undefined) pkuntaMkuntaChoiceElement.value = settings.pkuntaMkuntaChoice;
                 if (locationFilterValueElement && settings.locationFilterValue !== undefined) locationFilterValueElement.value = settings.locationFilterValue;
                 if (extraFilterElement && settings.extraFilter !== undefined) extraFilterElement.value = settings.extraFilter;

                 // Kutsu kuvatyypin vaihtohandleria, joka asettaa oikean UI-tilan ja kutsuu handlePkuntaMkuntaChoice:a
                 // Tämä myös populoi paikkakunta-apuvalikoiden maakuntavalikon, jos Paikkakunta oli tallennettu.
                 // Tarkista onko funktio määritelty ennen kutsua
                 if (typeof handleKuvatyyppiChange === 'function') {
                     handleKuvatyyppiChange(); // Tämä kutsuu toggleYearSpecificFilters -> handlePkuntaMkuntaChoice


                     // Aseta cachetype-arvo vasta kun handleKuvatyyppiChange on suoritettu (se voi lisätä Triplet-option)
                     if (cachetypeElement && settings.cachetype !== undefined) {
                          let loadedCachetype = settings.cachetype;
                          // Varmista, että tallennettu cachetype-arvo löytyy valikosta
                          if (loadedCachetype !== '' && !cachetypeElement.querySelector(`option[value="${loadedCachetype}"]`)) {
                               console.warn(`Loaded cachetype value "${loadedCachetype}" not found in select options. Resetting cachetype.`);
                               loadedCachetype = ''; // Aseta tyhjäksi, jos arvoa ei löydy
                           }
                          cachetypeElement.value = loadedCachetype;
                     }

                     // UUSI: Jos ladattu valinta oli Paikkakunta, yritä ladata apuvalikoiden arvot
                     // Tämä osa ajetaan vasta handleKuvatyyppiChange:n jälkeen, jotta handlePkuntaMkuntaChoice ehtii populoida maakuntavalikon
                     if (pkuntaMkuntaChoiceElement && pkuntaMkuntaChoiceElement.value === 'pkunta') {
                         if (municipalityRegionSelect && settings.municipalityRegionSelectValue !== undefined) {
                             municipalityRegionSelect.value = settings.municipalityRegionSelectValue;
                             console.log("Loaded municipality region select value:", settings.municipalityRegionSelectValue); // Debugging
                              // Populoi kuntavalikko maakuntavalinnan perusteella
                             // Tarkista onko funktio määritelty ennen kutsua
                             if (typeof populateMunicipalitySelect === 'function') {
                                 populateMunicipalitySelect();
                                  // Aseta kuntavalikkoon valittu arvo, jos tallennettu
                                  if (municipalitySelect && settings.municipalitySelectValue !== undefined) {
                                     municipalitySelect.value = settings.municipalitySelectValue;
                                     console.log("Loaded municipality select value:", settings.municipalitySelectValue); // Debugging
                                      // Aktivoi lisää-nappi jos kunta oli valittuna
                                      // Tarkista onko funktio määritelty ennen kutsua
                                     if (typeof handleMunicipalitySelectChange === 'function') {
                                        handleMunicipalitySelectChange(); // Kutsu tätä päivittämään napin tila
                                     } else { console.error("handleMunicipalitySelectChange not found during load."); }
                                  }
                             } else { console.error("populateMunicipalitySelect not found during load."); }
                         } else {
                              console.log("No saved municipality region select value found."); // Debugging
                         }
                     }


                 } else {
                      console.error("handleKuvatyyppiChange function not found during load. Fallback UI setup."); // Tämä virheviesti on nyt tarkoituksellinen
                       // Fallback logiikka, jos handleKuvatyyppiChange jostain syystä puuttuu
                       // Hae elementit uudelleen varmuuden vuoksi fallbackissa
                       const aikavalintaElement = document.getElementById("aikavalinta");
                       const pkuntaMkuntaChoiceElement = document.getElementById("pkuntaMkuntaChoice");
                       const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
                       const municipalitySelect = document.getElementById("municipalitySelect");
                       const addMunicipalityButton = document.getElementById("addMunicipalityButton"); // Tarvitaan nollaukseen/disablointiin


                       if (aikavalintaElement && typeof toggleAikaKentat === 'function') toggleAikaKentat();
                       // toggleYearSpecificFilters kutsuu handlePkuntaMkuntaChoice:a
                       if (pkuntaMkuntaChoiceElement && typeof toggleYearSpecificFilters === 'function') {
                           toggleYearSpecificFilters();
                       } else if (pkuntaMkuntaChoiceElement && typeof handlePkuntaMkuntaChoice === 'function') {
                           // Jos toggleYearSpecificFilters puuttuu, kutsutaan handlePkuntaMkuntaChoice suoraan
                           handlePkuntaMkuntaChoice();
                       } else {
                            // Äärimmäinen fallback: nollaa sijaintikenttä ja piilota apuelementit manuaalisesti
                            if (locationFilterValueElement) {
                                locationFilterValueElement.value = '';
                                locationFilterValueElement.disabled = true;
                                locationFilterValueElement.placeholder = "";
                            }
                             const regionInfoIcon = document.getElementById("regionInfoIcon");
                            const municipalitySelectAids = document.getElementById("municipalitySelectAids");
                            const regionListContainer = document.getElementById("regionListContainer");
                             if(regionInfoIcon) regionInfoIcon.style.display = 'none';
                             if(municipalitySelectAids) municipalitySelectAids.style.display = 'none';
                             if(regionListContainer) regionListContainer.style.display = 'none';
                             if (municipalityRegionSelect) municipalityRegionSelect.value = '';
                             if (municipalitySelect) {
                                  municipalitySelect.innerHTML = '<option value="">— Valitse kunta —</option>';
                                  municipalitySelect.disabled = true;
                             }
                             if (addMunicipalityButton) {
                                addMunicipalityButton.disabled = true;
                                addMunicipalityButton.style.backgroundColor = '#888';
                                addMunicipalityButton.style.cursor = 'not-allowed';
                             }
                       }


                       if (cachetypeElement && settings.cachetype !== undefined) cachetypeElement.value = settings.cachetype;


                        // Yritä ladata apuvalikoiden arvot fallbackissa
                       if (pkuntaMkuntaChoiceElement && pkuntaMkuntaChoiceElement.value === 'pkunta') {
                            if (municipalityRegionSelect && settings.municipalityRegionSelectValue !== undefined) {
                                 municipalityRegionSelect.value = settings.municipalityRegionSelectValue;
                                  if (typeof populateMunicipalitySelect === 'function') {
                                     populateMunicipalitySelect();
                                     if (municipalitySelect && settings.municipalitySelectValue !== undefined) {
                                         municipalitySelect.value = settings.municipalitySelectValue;
                                          if (typeof handleMunicipalitySelectChange === 'function') handleMunicipalitySelectChange();
                                     }
                                  }
                            }
                       }


                 }


             } else {
                 console.log("No settings found in Local Storage. Setting up default UI.");
                  // Jos asetuksia ei löytynyt, varmista oikea oletustila UI:lle
                 // Tarkista onko handleKuvatyyppiChange määritelty ennen kutsua
                 if (typeof handleKuvatyyppiChange === 'function') {
                      handleKuvatyyppiChange(); // Tämä kutsuu toggleYearSpecificFilters -> handlePkuntaMkuntaChoice
                  } else {
                     console.error("handleKuvatyyppiChange function not found during default setup. Fallback UI setup."); // Tämä virheviesti on nyt tarkoituksellinen
                     // Fallback
                     const aikavalintaElement = document.getElementById("aikavalinta");
                     const pkuntaMkuntaChoiceElement = document.getElementById("pkuntaMkuntaChoice");
                     const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
                     const municipalitySelect = document.getElementById("municipalitySelect");
                     const addMunicipalityButton = document.getElementById("addMunicipalityButton");


                     if (aikavalintaElement && typeof toggleAikaKentat === 'function') toggleAikaKentat();
                     if (pkuntaMkuntaChoiceElement && typeof toggleYearSpecificFilters === 'function') {
                          toggleYearSpecificFilters();
                     } else if (pkuntaMkuntaChoiceElement && typeof handlePkuntaMkuntaChoice === 'function') {
                          handlePkuntaMkuntaChoice();
                     } else {
                          // Äärimmäinen fallback
                          const locationFilterValueElement = document.getElementById("locationFilterValue");
                          const regionInfoIcon = document.getElementById("regionInfoIcon");
                          const municipalitySelectAids = document.getElementById("municipalitySelectAids");
                          const regionListContainer = document.getElementById("regionListContainer");
                          if (locationFilterValueElement) {
                                locationFilterValueElement.value = '';
                                locationFilterValueElement.disabled = true;
                                locationFilterValueElement.placeholder = "";
                           }
                           if(regionInfoIcon) regionInfoIcon.style.display = 'none';
                           if(municipalitySelectAids) municipalitySelectAids.style.display = 'none';
                           if(regionListContainer) regionListContainer.style.display = 'none';
                            if (municipalityRegionSelect) municipalityRegionSelect.value = '';
                            if (municipalitySelect) {
                                municipalitySelect.innerHTML = '<option value="">— Valitse kunta —</option>';
                                municipalitySelect.disabled = true;
                            }
                            if (addMunicipalityButton) {
                                addMunicipalityButton.disabled = true;
                                addMunicipalityButton.style.backgroundColor = '#888';
                                addMunicipalityButton.style.cursor = 'not-allowed';
                            }
                     }
                 }
             }
         } catch (e) {
             console.error("Could not load settings from Local Storage", e);
             // Jos latauksessa virhe, poista rikkinäiset asetukset ja palauta oletustila
             localStorage.removeItem('statGeneratorSettings');
              console.log("Cleared potentially corrupted Local Storage settings.");
             // Varmista UI:n oletustila virheen sattuessa
             // Tarkista onko handleKuvatyyppiChange määritelty ennen kutsua
              if (typeof handleKuvatyyppiChange === 'function') {
                  handleKuvatyyppiChange();
              } else {
                   console.error("handleKuvatyyppiChange function not found after load error. Fallback UI setup."); // Tämä virheviesti on nyt tarkoituksellinen
                 // Fallback
                 const aikavalintaElement = document.getElementById("aikavalinta");
                 const pkuntaMkuntaChoiceElement = document.getElementById("pkuntaMkuntaChoice");
                 const municipalityRegionSelect = document.getElementById("municipalityRegionSelect");
                 const municipalitySelect = document.getElementById("municipalitySelect");
                 const addMunicipalityButton = document.getElementById("addMunicipalityButton");

                 if (aikavalintaElement && typeof toggleAikaKentat === 'function') toggleAikaKentat();
                 if (pkuntaMkuntaChoiceElement && typeof toggleYearSpecificFilters === 'function') {
                      toggleYearSpecificFilters();
                 } else if (pkuntaMkuntaChoiceElement && typeof handlePkuntaMkuntaChoice === 'function') {
                     handlePkuntaMkuntaChoice();
                 } else {
                      // Äärimmäinen fallback
                      const locationFilterValueElement = document.getElementById("locationFilterValue");
                      const regionInfoIcon = document.getElementById("regionInfoIcon");
                      const municipalitySelectAids = document.getElementById("municipalitySelectAids");
                      const regionListContainer = document.getElementById("regionListContainer");
                      if (locationFilterValueElement) {
                            locationFilterValueElement.value = '';
                            locationFilterValueElement.disabled = true;
                            locationFilterValueElement.placeholder = "";
                       }
                       if(regionInfoIcon) regionInfoIcon.style.display = 'none';
                       if(municipalitySelectAids) municipalitySelectAids.style.display = 'none';
                       if(regionListContainer) regionListContainer.style.display = 'none';
                        if (municipalityRegionSelect) municipalityRegionSelect.value = '';
                        if (municipalitySelect) {
                            municipalitySelect.innerHTML = '<option value="">— Valitse kunta —</option>';
                            municipalitySelect.disabled = true;
                        }
                        if (addMunicipalityButton) {
                            addMunicipalityButton.disabled = true;
                            addMunicipalityButton.style.backgroundColor = '#888';
                            addMunicipalityButton.style.cursor = 'not-allowed';
                        }
                 }
             }
         }
    }


    // --- DOMContentLoaded -tapahtumankäsittelijä ---
    // Tämä ajetaan kun koko HTML-dokumentti (DOM) on latautunut ja jäsennetty
    document.addEventListener('DOMContentLoaded', (event) => {
        console.log("DOMContentLoaded event fired. Starting UI setup."); // Debugging

        // Populate dropdowns (vuosi ja kuukausi)
        const yearSelect = document.getElementById("year");
        const monthSelect = document.getElementById("month");

        if (yearSelect) {
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            const defaultYearOpt = document.createElement("option");
            defaultYearOpt.value = "current";
            defaultYearOpt.textContent = "—";
            yearSelect.appendChild(defaultYearOpt);
            for (let y = 2000; y <= currentYear; y++) {
                const opt = document.createElement("option");
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            }
             if (yearSelect.value === "") { yearSelect.value = "current"; }
        } else { console.error("Year select element (#year) not found."); }

        if (monthSelect) {
            monthSelect.innerHTML = '';
            const defaultMonthOpt = document.createElement("option");
            defaultMonthOpt.value = "current";
            defaultMonthOpt.textContent = "—";
            monthSelect.appendChild(defaultMonthOpt);
            const monthNames = ["Tammi", "Helmi", "Maalis", "Huhti", "Touko", "Kesä", "Heinä", "Elo", "Syys", "Loka", "Marras", "Joulu"];
            for (let m = 0; m < 12; m++) {
                const opt = document.createElement("option");
                opt.value = (m + 1).toString().padStart(2, '0');
                opt.textContent = monthNames[m];
                monthSelect.appendChild(opt);
            }
             if (monthSelect.value === "") { monthSelect.value = "current"; }
        } else { console.error("Month select element (#month) not found."); }


        // --- Add Event Listeners (check if elements exist) ---
        // Event listeners for elements that are always in DOM or whose handlers are called by other handlers
        // Huom: onchange/onclick HTML-attribuutit kutsuvat suoraan globaaleja funktioita,
        // joten addEventListeneria ei tarvita tässä niille elementeille, joissa on jo onchange/onclick.
        const imageElement = document.getElementById("kuva");
        const copyLinkButton = document.getElementById("copyLinkButton");
        const resetButton = document.getElementById("resetButton");
        const regionInfoIcon = document.getElementById("regionInfoIcon"); // Maakunta icon
        const municipalityRegionSelect = document.getElementById("municipalityRegionSelect"); // Paikkakunta -> Maakunta valikko
        const municipalitySelect = document.getElementById("municipalitySelect"); // Paikkakunta -> Kunta valikko
        const addMunicipalityButton = document.getElementById("addMunicipalityButton"); // Paikkakunta Lisää -nappi


         // Näiden handlerit on jo onchange/onclick HTML:ssä: kuvatyyppi, aikavalinta, pkuntaMkuntaChoice, luoLinkki
         // Lisätään kuuntelijat elementeille, joilla ei ole onchange/onclick atribuuttia HTML:ssä

         if (imageElement) {
            imageElement.addEventListener('click', function() {
                const largeMapUrl = this.dataset.largeMapUrl;
                if (largeMapUrl) {
                    window.open(largeMapUrl, '_blank');
                }
            });
         } else { console.error("Image element (#kuva) not found for listener."); }

         if (copyLinkButton) {
            copyLinkButton.addEventListener('click', function() {
                const urlToCopy = this.dataset.urlToCopy;
                if (urlToCopy) {
                    navigator.clipboard.writeText(urlToCopy)
                        .then(() => {
                            const originalText = this.textContent;
                            this.textContent = "Kopioitu!";
                            setTimeout(() => { this.textContent = originalText; }, 2000);
                        })
                        .catch(err => {
                            console.error('Linkin kopiointi epäonnistui:', err);
                             const originalText = this.textContent;
                             this.textContent = "Kopiointi epäonnistui!";
                             setTimeout(() => {
                                this.textContent = originalText;
                            }, 3000);
                        });
                }
            });
         } else { console.error("Copy link button (#copyLinkButton) not found for listener."); }

        // --- Add listener for the Region Info Icon (Maakunta list popup) ---
         if (regionInfoIcon) {
            regionInfoIcon.addEventListener('click', toggleRegionList);
         } else { console.error("Region info icon (#regionInfoIcon) not found."); }

        // --- Kuuntelija maakuntavalikolle paikkakunta-apuvalikoissa ---
        if (municipalityRegionSelect) {
            municipalityRegionSelect.addEventListener('change', populateMunicipalitySelect);
        } else { console.error("Municipality region select (#municipalityRegionSelect) not found."); }

        // --- Kuuntelija kuntavalikolle paikkakunta-apuvalikoissa (Lisää-napin aktivointi) ---
         if (municipalitySelect) {
            municipalitySelect.addEventListener('change', handleMunicipalitySelectChange);
         } else { console.error("Municipality select (#municipalitySelect) not found."); }


        // --- Kuuntelija "Lisää kunta" -napille ---
        if (addMunicipalityButton) {
            addMunicipalityButton.addEventListener('click', addSelectedMunicipality);
        } else { console.error("Add municipality button (#addMunicipalityButton) not found."); }


        // --- Lisää kuuntelija Nollaa-napille ---
        // Tämän handlerin kutsuminen on jo HTML:n onclickissä
         if (resetButton) {
            // resetButton.addEventListener('click', function() { ... }); // handler is in onclick
         } else { console.error("Reset button (#resetButton) not found for listener."); }


        // --- Lataa asetukset Local Storagesta ---
        // Kutsutaan asetusten latausta, joka kutsuu tarvittavia handlereita ja päivittää UI:n
        loadSettingsFromLocalStorage();

    }); // DOMContentLoaded päättyy


    // --- Kutsutaan asetusten latausta heti kun DOM on valmis ---
    // Tämä kutsu varmistettiin DOMContentLoadedin sisällä
    // loadSettingsFromLocalStorage(); // Tätä ei kutsuta tässä ulkona

  </script>
</body>
</html>
