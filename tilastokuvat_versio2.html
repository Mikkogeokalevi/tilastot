<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Kätkö tilastojen - Kuvageneraattori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      /* Määritellään värejä CSS-muuttujiin, helpottaa ylläpitoa */
      --bg-color-dark: #1e1e2e; /* Syvempi tumma tausta */
      --text-color-light: #cdd6f4; /* Pehmeämpi vaalea teksti */
      --card-bg: #313244; /* Elementtien tausta */
      --border-color: #45475a; /* Reunusten väri */
      --accent-color: #89b4fa; /* Korostusväri linkeille/napeille (valinnainen) */
      --button-bg: #585b70; /* Nappien tausta */
      --button-hover-bg: #6c7086; /* Nappien hover-tausta */
      --border-radius: 8px; /* Yleinen kulmien pyöristys */
      --spacing-small: 0.5em;
      --spacing-medium: 1em;
      --spacing-large: 1.5em;

      /* Uusia, pienempiä väljyyksiä mobiilille */
      --spacing-mobile-small: 0.3em;
      --spacing-mobile-medium: 0.8em;
      --spacing-mobile-large: 1em;
    }

    body {
      background-color: var(--bg-color-dark);
      color: var(--text-color-light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Hiukan modernimpi fontti */
      margin: var(--spacing-medium);
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: var(--spacing-large) auto; /* Keskitetty ja ylä/alareunaan tilaa */
      padding: var(--spacing-large);
      background-color: var(--card-bg); /* Containerille oma tausta */
      border-radius: var(--border-radius);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Kevyt varjo */
    }

    /* Uusi tyyli otsikkoalueelle, jossa logo ja teksti ovat rinnakkain */
    .header-area {
        display: flex; /* Käytetään flexboxia */
        align-items: center; /* Keskitetään elementit pystysuunnassa */
        margin-bottom: var(--spacing-large); /* Lisätään reilusti tilaa otsikkoalueen alle */
        padding-bottom: var(--spacing-medium); /* Pieni sisäinen alareuna */
        border-bottom: 1px solid var(--border-color); /* Kevyt erotinviiva */
    }

    /* Tyyli logokuvalle otsikkoalueella */
    .header-area .logo {
        width: 70px; /* Suurempi koko logolle */
        height: 70px; /* Neliö */
        margin-right: var(--spacing-medium); /* Lisää tilaa logon ja tekstin väliin */
        border: none; /* Poista mahdollinen kuvan reunus */
        flex-shrink: 0; /* Estää logoa kutistumasta liikaa pienellä näytöllä */
        border-radius: var(--border-radius); /* Pyöristetään myös logon kulmia */
    }

    /* Tyyli otsikkotekstille otsikkoalueella */
    .header-area h2 {
        margin: 0; /* Poistaa h2:n oletusmarginaalit */
        font-size: 1.8em; /* Hieman suurempi otsikko */
        color: var(--text-color-light); /* Varmistetaan tekstin väri */
    }

    label {
      display: inline-block;
      margin-bottom: var(--spacing-small);
      margin-top: var(--spacing-medium);
      font-weight: bold; /* Labelit lihavoituina */
    }

    select, input[type="date"], input[type="text"] {
      width: calc(100% - 1em); /* Leveys 100% miinus padding, jotta pysyy containerissa */
      padding: var(--spacing-small);
      margin-bottom: var(--spacing-medium);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius); /* Pyöreämmät kulmat */
      background-color: var(--bg-color-dark); /* Sama tausta kuin bodyllä tai hieman tummempi */
      color: var(--text-color-light);
      font-size: 1em;
      box-sizing: border-box; /* Sisällytä padding ja border leveyteen */
    }

    /* Lomake-elementtien focus-tila */
     select:focus, input[type="date"]:focus, input[type="text"]:focus {
        outline: none; /* Poista oletus focus-reunus */
        border-color: var(--accent-color); /* Korosta reunus focus-värillä */
        box-shadow: 0 0 5px var(--accent-color); /* Lisää kevyt varjo */
     }


    .row {
      display: flex;
      gap: var(--spacing-small); /* Pienempi rako elementtien välissä */
      flex-wrap: wrap;
      width: 100%;
      margin-bottom: var(--spacing-medium); /* Lisää tilaa rivin alle */
    }

    .row > div {
      flex: 1;
      min-width: 100px; /* Pienennetty minimileveys riveillä, jotta mahtuu 4 elementtiä */
    }

    button {
      margin-top: var(--spacing-medium);
      padding: var(--spacing-small) var(--spacing-medium);
      background-color: var(--button-bg);
      color: var(--text-color-light);
      border: none;
      border-radius: var(--border-radius); /* Pyöreämmät kulmat */
      cursor: pointer;
      font-size: 1.1em; /* Hieman suurempi teksti napissa */
      transition: background-color 0.3s ease; /* Animaatio hoveriin */
    }

    button:hover {
      background-color: var(--button-hover-bg);
    }

    a {
      color: var(--accent-color); /* Linkkien väri */
      display: inline-block;
      margin-top: var(--spacing-medium);
      text-decoration: none; /* Poista alleviivaus */
      transition: color 0.3s ease;
    }

    a:hover {
        color: #a6e3a1; /* Hieman eri sävy hoverissa */
        text-decoration: underline; /* Lisää alleviivaus hoverissa */
    }

    /* --- Uudet säännöt kuvan ja overlayn wrapperille sekä overlaylle --- */
    .image-wrapper {
        position: relative; /* Mahdollistaa suhteellisen sisällön */
        display: block; /* Varmistaa, että vie tilaa */
        margin-top: var(--spacing-medium); /* Tilaa wrapperin yläpuolelle */
        max-width: 100%; /* Varmistaa, ettei wrapper mene yli containerin leveyden */
        /* Piilotetaan oletuksena tai jos kuvaa ei ole */
        display: none;
        text-align: center; /* Keskitetään sekä teksti että kuva wrapperin sisällä */
    }

    .image-wrapper #kuva { /* Tyyli kuvalle wrapperin sisällä */
        display: block; /* Kuva omalle rivilleen */
        max-width: 100%; /* Kuva täyttää wrapperin leveyden */
        height: auto; /* Säilyttää kuvasuhteen */
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        cursor: default; /* Oletuskursori, JS muuttaa tarvittaessa */
        margin: 0 auto; /* Keskitä kuva wrapperin sisällä */
    }

    #map-overlay { /* Tyyli tekstille kuvan YLÄPUOLELLA */
        display: block; /* Varmistaa, että vie tilaa */
        text-align: center; /* Keskitetään vaakasuunnassa */
        color: var(--text-color-light); /* Tekstin väri */
        font-size: 0.9em; /* Pienempi fonttikoko */
        margin-bottom: var(--spacing-small); /* Tilaa tekstin ja kuvan väliin */
        display: none; /* Piilotettu oletuksena */
    }
    /* --- Uudet säännöt päättyvät --- */


    /* Tyyli linkille ladatun kuvan alla */
    a#linkki { /* Kohdennetaan tarkemmin linkkiin kuvan alla */
        margin-top: var(--spacing-medium);
        /* Piilotetaan oletuksena tai jos kuva itse on linkki */
         display: none;
         /* Muita linkkityylejä */
    }

    /* Tyyli kopiointinapille */
    #copyLinkButton {
        margin-top: var(--spacing-small); /* Ylämarginaali erottamaan linkistä/kuvasta */
        padding: 0.4em 0.8em; /* Pienempi padding kuin päänapissa */
        font-size: 0.9em; /* Pienempi fonttikoko */
        display: none; /* Piilotettu oletuksena */
        /* Perii muita nappityylejä (tausta, väri, reunat, kursori jne.) */
    }


    /* Mobiililaitteille (< 600px) */
    @media (max-width: 600px) {
        body {
            margin: var(--spacing-mobile-medium); /* Pienemmät marginaalit bodylle */
        }
        .container {
            padding: var(--spacing-mobile-large); /* Pienempi padding containerissa */
            margin: var(--spacing-mobile-large) auto; /* Pienemmät ylä/alamarginaalit containerissa */
        }
        /* Säätöjä pienemmille näytöille */
        .header-area {
            flex-direction: column; /* Pino elementit pystysuuntaan */
            align-items: flex-start; /* Kohdista vasemmalle */
             margin-bottom: var(--spacing-mobile-large);
        }
        .header-area .logo {
            margin-right: 0; /* Poista oikea marginaali pinottaessa */
            margin-bottom: var(--spacing-mobile-medium); /* Lisää tilaa logon alle */
            width: 60px; /* Voit säätää kokoa pienemmäksi */
            height: 60px; /* Voit säätää kokoa pienemmäksi */
        }
        .header-area h2 {
             font-size: 1.5em; /* Hieman pienempi otsikko mobiilissa */
        }

        label {
            margin-top: var(--spacing-mobile-medium); /* Pienempi ylämarginaali labeleille */
            margin-bottom: var(--spacing-mobile-small); /* Pienempi alamarginaali labeleille */
        }

        select, input[type="date"], input[type="text"] {
            margin-bottom: var(--spacing-mobile-medium); /* Pienempi alamarginaali lomake-elementeille */
            padding: var(--spacing-mobile-small); /* Pienempi padding lomake-elementeille */
        }

        .row {
             margin-bottom: var(--spacing-mobile-medium); /* Pienempi tila rivin alle */
             /* Jos rivillä 4 elementtiä mobiilissa, ne voivat pinoutua */
             flex-direction: column;
             gap: var(--spacing-mobile-medium);
        }
         .row > div {
             min-width: 100%; /* Mobiilissa div vie 100% rivin leveydestä */
         }

        button {
            margin-top: var(--spacing-mobile-medium); /* Pienempi ylämarginaali napille */
            padding: var(--spacing-mobile-small) var(--spacing-mobile-medium); /* Pienempi padding napille */
            width: 100%; /* Nappi 100% leveäksi */
        }

        a#linkki { /* Kohdennetaan tarkemmin linkkiin kuvan alla */
            margin-top: var(--spacing-mobile-medium); /* Pienempi ylämarginaali linkille */
        }

        #map-overlay { /* Säädetään overlayta mobiilissa */
             font-size: 0.8em; /* Hieman pienempi fontti mobiilissa */
             margin-bottom: var(--spacing-mobile-small); /* Pienempi marginaali */
        }
        #copyLinkButton { /* Säädetään kopiointinappia mobiilissa */
            margin-top: var(--spacing-mobile-small); /* Pienempi ylämarginaali */
             width: 100%; /* Tee napista 100% leveä mobiilissa */
        }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-area">
        <img src="mikkokalevi.png" alt="Sivuston logo" class="logo">
        <h2>Kätkö tilastojen - Kuvageneraattori</h2>
    </div>

    <label for="user">Käyttäjätunnus:</label>
    <input type="text" id="user" list="userlist" placeholder="esim. mikkokalevi">
    <datalist id="userlist">
      <option value="mikkokalevi">
      <option value="Tiltu">
      <option value="lahjemies">
      <option value="eukka">
      <option value="Milde04"> </datalist>

    <label for="kuvatyyppi">Kuvan tyyppi:</label>
    <select id="kuvatyyppi">
      <option value="matrix">T/D-taulukko</option>
      <option value="kunta">Kuntakartta</option>
      <option value="year">Vuosikalenteri</option>
      <option value="ftfkunta">ftf kunta</option>
      <option value="hiddenday">Jasmer</option>
      <option value="saari">saarilöydöt</option>
    </select>

    <label for="aikavalinta">Aikarajaus:</label>
    <select id="aikavalinta" onchange="toggleAikaKentat()">
      <option value="ei">Ei aikarajausta</option>
      <option value="kylla">Valitse aikaväli</option>
    </select>

    <div id="aikaKentat" style="display:none;">
      <div class="row">
        <div>
          <label for="year">Vuosi:</label>
          <select id="year">
            <option value="current">—</option>
          </select>
        </div>
         <div>
          <label for="month">Kuukausi:</label>
          <select id="month">
            <option value="current">—</option>
          </select>
        </div>
         <div>
          <label for="startdate">Alkupäivä:</label>
          <input type="date" id="startdate">
        </div>
        <div>
          <label for="enddate">Loppupäivä:</label>
          <input type="date" id="enddate">
        </div>
      </div>
    </div>

    <label for="cachetype">Kätkötyyppi:</label>
    <select id="cachetype">
      <option value="">—</option>
      <option value="1">Traditional Cache</option>
      <option value="2">Multi-cache</option>
      <option value="3">Unknown Cache</option>
      <option value="4">Letterbox Hybrid</option>
      <option value="5">Event Cache</option>
      <option value="6">Earthcache</option>
      <option value="7">Virtual Cache</option>
      <option value="8">Webcam Cache</option>
      <option value="9">Wherigo Cache</option>
      <option value="10">Community Celebration Event</option>
      <option value="11">Mega-Event Cache</option>
      <option value="12">Cache In Trash Out Event</option>
      <option value="13">Giga-Event Cache</option>
      <option value="14">Groundspeak Block Party</option>
      <option value="98">Muut paitsi tradit</option>
      <option value="99">Kaikki event-tyypit</option>
    </select>

    <button onclick="luoLinkki()">Luo linkki ja kuva</button>

    <div class="image-wrapper">
      <div id="map-overlay">Klikkaa karttaa isommaksi</div>
      <img id="kuva" alt="">
    </div>

    <a id="linkki" href="#" target="_blank"></a>

    <button id="copyLinkButton">Kopioi linkki</button>


  </div>

  <script>
    // Mappaus käyttäjien nimimerkkien ja userid:den välillä
    // Lisää "Milde04": sen ID tähän, kun saat sen
    const userIds = {
        "mikkokalevi": 306478,
        "eukka": 36206,
        "Tiltu": 309395,
        "lahjemies": 308779,
        // "Milde04": XXXX // Lisää Milde04:n ID tähän
    };

    function formatDate(input) {
      const parts = input.split("-");
      return parts.length === 3 ? `${parts[2]}.${parts[1]}.${parts[0]}` : "";
    }

    function toggleAikaKentat() {
      const valinta = document.getElementById("aikavalinta").value;
      document.getElementById("aikaKentat").style.display = valinta === "kylla" ? "block" : "none";
    }

    function luoLinkki() {
      const baseUrl = "https://www.geocache.fi/stat/";
      const kuvatyyppi = document.getElementById("kuvatyyppi").value;
      const user = document.getElementById("user").value.trim();
      const start = document.getElementById("startdate").value;
      const end = document.getElementById("enddate").value;
      const cachetype = document.getElementById("cachetype").value; // Hae kätkötyyppi
      const aikavalinta = document.getElementById("aikavalinta").value;
      const year = document.getElementById("year").value;
      const month = document.getElementById("month").value; // UUSI: Hae kuukausivalinta

      const imageElement = document.getElementById("kuva");
      const linkElementBelow = document.getElementById("linkki");
      const overlayElement = document.getElementById("map-overlay"); // Hae overlay-elementti
      const imageWrapper = document.querySelector('.image-wrapper'); // Hae kuvan wrapper-elementti
      const copyLinkButton = document.getElementById("copyLinkButton"); // Hae kopiointinappi


      // --- Reset output elements visibility ---
      if (imageWrapper) imageWrapper.style.display = 'none';
      overlayElement.style.display = 'none';
      linkElementBelow.style.display = 'none';
      copyLinkButton.style.display = 'none';
      imageElement.src = ''; // Clear previous image source


      if (!user) {
        alert("Syötä käyttäjänimi.");
        return;
      }

      // Oletuksena muodostettava URL kuvalle
      let params = `?user=${encodeURIComponent(user)}`;

      // Add type=2 parameter specifically for hiddenday
      if (kuvatyyppi === "hiddenday") {
        params += `&type=2`;
      }

      // --- Aikavalinta-logiikka ---
      if (aikavalinta === "kylla") {
        if (start && end) {
          // Jos päivämääräväli on valittu, käytä sitä (ensisijainen)
          params += `&startdate=${formatDate(start)}&enddate=${formatDate(end)}`;
        } else {
          // Jos päivämääräväliä EI ole, käytä vuotta ja/tai kuukautta
          if (year && year !== "current") {
               params += `&year=${year}`;
          }
          if (month && month !== "current") {
              // Lisää kuukausi parametri (arvot ovat jo 01-12)
              // Tarkista, onko jo parametreja, jotta lisätään &
               if (params.includes('?')) {
                   params += `&month=${month}`;
               } else {
                   // Tämä skenaario (ei user= parametriä) ei pitäisi toteutua nykyrakenteessa
                   params += `?month=${month}`;
               }
          }
        }
      }

      // Lisää kätkötyyppi oletus-URLiin
      if (cachetype) {
        params += `&cachetype=${cachetype}`;
      }

      const finalUrl = `${baseUrl}${kuvatyyppi}.php${params}`;

      // URL, joka kopioidaan leikepöydälle (oletuksena finalUrl)
      let urlToCopy = finalUrl;

      // --- Kuntakartta-spesifi logiikka ---
      const selectedUserId = userIds[user]; // Hakee userid:n, jos käyttäjä on mappauksessa

      if (kuvatyyppi === "kunta" && selectedUserId) {
          // Jos kuvatyyppi on kuntakartta JA käyttäjällä on tunnettu userid
          let largeMapUrl = `${baseUrl}kunta/?userid=${selectedUserId}&names=1`;

          // Lisää kätkötyyppi, jos valittu
          if (cachetype) {
              largeMapUrl += `&cachetype=${cachetype}`;
          }
          // UUSI: Lisää vuosi ja kuukausi, jos ne on valittu aikavalinnalle (ja päivämääräväliä ei ole)
          if (aikavalinta === "kylla" && !(start && end)) {
               if (year && year !== "current") {
                   largeMapUrl += `&year=${year}`;
               }
               if (month && month !== "current") {
                   largeMapUrl += `&month=${month}`;
               }
          }


          // URL to copy is the large map URL in this case
          urlToCopy = largeMapUrl;

          // Aseta kuvan lähde (pieni kartta)
          imageElement.src = finalUrl;
          imageElement.alt = "Kuntakartta (klikkaa isompaan kuvaan)";

          // Tallenna ison kartan linkki data-attribuuttiin
          imageElement.dataset.largeMapUrl = largeMapUrl;

          // Muuta kursori osoittamaan, että kuva on klikattava
          imageElement.style.cursor = 'pointer';

          // Piilota linkki kuvan alla
          linkElementBelow.style.display = 'none';

          // Näytä overlay-teksti kuvan yläpuolella
          overlayElement.style.display = 'block';


      } else {
          // --- Muut kuvatyypit TAI kuntakartta tuntemattomalle käyttäjälle ---
          // Aseta kuvan lähde normaalisti
          imageElement.src = finalUrl;
          imageElement.alt = "Tilastokuva"; // Oletus alt-teksti

          // Varmista, että data-attribuutti on poistettu (jotta kuva ei ole linkki)
          delete imageElement.dataset.largeMapUrl;
          imageElement.style.cursor = 'default'; // Palauta kursori oletusarvoon

          // Näytä linkki kuvan alla normaalisti
          linkElementBelow.href = finalUrl;
          linkElementBelow.textContent = "Avaa kuva uudessa ikkunassa";
          linkElementBelow.style.display = 'inline-block'; // Tai muu sopiva display-arvo

          // Piilota overlay-teksti
          overlayElement.style.display = 'none';
      }

      // --- Handle image/output area visibility ---
       if (finalUrl && imageElement.src && !imageElement.src.includes('undefined') && !imageElement.src.includes('null')) {
            // Kaikki ok, näytä wrapper, kuva, ja joko overlay tai linkki alla (ne on jo asetettu oikein yllä)
            if (imageWrapper) imageWrapper.style.display = 'block';

            // --- Näytä Kopioi linkki -nappi ja aseta sen data-url ---
            copyLinkButton.style.display = 'inline-block'; // Näytä nappi
            copyLinkButton.dataset.urlToCopy = urlToCopy; // Tallenna kopioitava URL data-attribuuttiin

            // --- Tallenna valinnat Local Storageen onnistumisen jälkeen ---
            const settingsToSave = {
                user: user,
                kuvatyyppi: kuvatyyppi,
                aikavalinta: aikavalinta,
                year: year,
                month: month, // Tallenna myös kuukausi
                startdate: start,
                enddate: end,
                cachetype: cachetype
            };
            try {
                localStorage.setItem('statGeneratorSettings', JSON.stringify(settingsToSave));
            } catch (e) {
                console.error("Could not save settings to Local Storage", e);
                // Voit näyttää tässä käyttäjälle jonkin ei-häiritsevän ilmoituksen
            }

        } else {
            // Jos finalUrl on tyhjä tai virheellinen, piilota kaikki
            if (imageWrapper) imageWrapper.style.display = 'none';
            overlayElement.style.display = 'none';
            linkElementBelow.style.display = 'none';
            copyLinkButton.style.display = 'none';
            // alert("Kuvaa ei voitu luoda valituilla asetuksilla."); // Voit näyttää virheen täälläkin
        }
    }

    // --- DOMContentLoaded -tapahtumankäsittelijä ---
    // Suoritetaan, kun koko HTML-dokumentti on latautunut ja jäsennetty
    document.addEventListener('DOMContentLoaded', (event) => {

        // --- Lisää vuodet dropdown-valikkoon ---
        const yearSelect = document.getElementById("year");
        const currentYear = new Date().getFullYear();
        // Tyhjennä olemassa olevat optiot varmuuden vuoksi
        yearSelect.innerHTML = '';
        // Lisää "--" optioksi ensimmäiseksi
        const defaultYearOpt = document.createElement("option");
        defaultYearOpt.value = "current";
        defaultYearOpt.textContent = "—";
        yearSelect.appendChild(defaultYearOpt);
        // Lisää vuodet 2000 -> nykyinen vuosi
        for (let y = 2000; y <= currentYear; y++) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        }
        // Aseta oletusarvo, jos sitä ei ladata tallennuksesta
         if (yearSelect.value === "") {
            yearSelect.value = "current";
        }

        // --- UUSI: Lisää kuukaudet dropdown-valikkoon ---
        const monthSelect = document.getElementById("month");
        if (monthSelect) {
            // Tyhjennä olemassa olevat optiot varmuuden vuoksi
            monthSelect.innerHTML = '';
            // Lisää "--" optioksi ensimmäiseksi
            const defaultMonthOpt = document.createElement("option");
            defaultMonthOpt.value = "current";
            defaultMonthOpt.textContent = "—";
            monthSelect.appendChild(defaultMonthOpt);

            const monthNames = ["Tammi", "Helmi", "Maalis", "Huhti", "Touko", "Kesä", "Heinä", "Elo", "Syys", "Loka", "Marras", "Joulu"];
            for (let m = 0; m < 12; m++) {
                const opt = document.createElement("option");
                // Kuukauden arvo 1-12, padded two digits (01-12)
                opt.value = (m + 1).toString().padStart(2, '0');
                opt.textContent = monthNames[m];
                monthSelect.appendChild(opt);
            }
            // Aseta oletusarvo, jos sitä ei ladata tallennuksesta
             if (monthSelect.value === "") {
                monthSelect.value = "current";
            }
        }


        // --- Lataa asetukset Local Storagesta ---
        try {
            const savedSettings = localStorage.getItem('statGeneratorSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                // Täytä kentät, jos asetuksia löytyi
                if (settings.user !== undefined) document.getElementById("user").value = settings.user;
                if (settings.kuvatyyppi !== undefined) document.getElementById("kuvatyyppi").value = settings.kuvatyyppi;
                if (settings.aikavalinta !== undefined) {
                     document.getElementById("aikavalinta").value = settings.aikavalinta;
                     // Kutsu toimintoa näyttämään/piilottamaan aikakentät ladatun valinnan perusteella
                     toggleAikaKentat();
                }
                // Täytä päivämäärä/vuosi/kuukausi -kentät vain, jos aikarajaus oli "kylla"
                if (settings.aikavalinta === 'kylla') {
                     if (settings.year !== undefined) document.getElementById("year").value = settings.year;
                     // UUSI: Lataa kuukausi
                     if (settings.month !== undefined) document.getElementById("month").value = settings.month;
                     if (settings.startdate !== undefined) document.getElementById("startdate").value = settings.startdate;
                     if (settings.enddate !== undefined) document.getElementById("enddate").value = settings.enddate;
                }
                if (settings.cachetype !== undefined) document.getElementById("cachetype").value = settings.cachetype;

                 // Huom: Tämä lataa vain kentät. Kuva ja linkki muodostetaan vasta, kun käyttäjä klikkaa "Luo linkki ja kuva".

            }
        } catch (e) {
            console.error("Could not load settings from Local Storage", e);
            // Valinnaisesti tyhjennä mahdollisesti vioittunut data:
            // localStorage.removeItem('statGeneratorSettings');
        }


        // --- Lisää klikkikuuntelija kuva-elementille ---
        // Tämä kuuntelija tarkistaa aina, onko data-large-map-url attribuutti asetettu
        const imageElement = document.getElementById("kuva");
        if (imageElement) {
            imageElement.addEventListener('click', function() {
                // Tarkista, onko data-large-map-url attribuutti olemassa
                const largeMapUrl = this.dataset.largeMapUrl;
                if (largeMapUrl) {
                    // Jos attribuutti löytyy, avaa linkki uudessa välilehdessä
                    window.open(largeMapUrl, '_blank');
                }
                // Jos attribuuttia ei ole, kuva ei ole klikattava linkiksi tässä tapauksessa
            });
        }

        // --- Lisää klikkikuuntelija Kopioi linkki -napille ---
        const copyLinkButton = document.getElementById("copyLinkButton");
         if (copyLinkButton) {
            copyLinkButton.addEventListener('click', function() {
                const urlToCopy = this.dataset.urlToCopy; // Hae URL data-attribuutista
                if (urlToCopy) {
                    // Käytä Clipboard APIa linkin kopioimiseen
                    navigator.clipboard.writeText(urlToCopy)
                        .then(() => {
                            // Onnistui - anna käyttäjälle palautetta
                            const originalText = this.textContent;
                            this.textContent = "Kopioitu!";
                            // Palauta napin teksti hetken kuluttua
                            setTimeout(() => {
                                this.textContent = originalText;
                            }, 2000); // Näytä "Kopioitu!" 2 sekunnin ajan
                        })
                        .catch(err => {
                            // Epäonnistui - anna käyttäjälle palautetta ja logita virhe
                            console.error('Linkin kopiointi epäonnistui:', err);
                             const originalText = this.textContent;
                             this.textContent = "Kopiointi epäonnistui!";
                             setTimeout(() => {
                                this.textContent = originalText;
                            }, 3000); // Näytä virhe 3 sekunnin ajan
                            // Valinnaisesti, jos Clipboard API ei toimi (esim. http-yhteys),
                            // voit tarjota manuaalista kopiointia:
                            // prompt("Kopioi linkki manuaalisesti (Ctrl+C tai Cmd+C):", urlToCopy);
                        });
                }
            });
        }

    }); // DOMContentLoaded päättyy

  </script>
</body>
</html>
